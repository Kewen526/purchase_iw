<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>采购IW</title>
    <style>
        /* V31风格配色方案 */
        :root {
            --bg: #f8fafc;
            --bg-2: #f1f5f9;
            --card: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --muted: #94a3b8;
            --brand: #2563eb;
            --brand-2: #3b82f6;
            --brand-light: #dbeafe;
            --line: #e2e8f0;
            --ring: #93c5fd;
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --error: #ef4444;
            --error-light: #fecaca;
            --info: #6366f1;
            --info-light: #e0e7ff;
            --purple: #a855f7;
            --purple-light: #f3e8ff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,"Helvetica Neue",Arial,"Noto Sans CJK SC","PingFang SC",sans-serif;
        }
        
        body {
            background: 
                radial-gradient(circle at 20% 80%, rgba(120,119,198,0.15), transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255,119,198,0.15), transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(59,130,246,0.1), transparent 50%),
                linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            background-size: 800px 800px, 600px 600px, 400px 400px, 100% 100%;
            min-height: 100vh;
            color: var(--text);
            padding: 20px;
            min-width: 320px;
        }

        /* 动画定义 */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(241,245,249,0.8);
            border-radius: 8px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #cbd5e1, #94a3b8);
            border-radius: 8px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #94a3b8, #64748b);
        }
        
        .main-container {
            display: flex;
            width: 100%;
            gap: 24px;
            max-width: 1920px;
            margin: 0 auto;
            animation: slideIn 0.8s ease-out;
        }
        
        .sidebar {
            width: 20%;
            min-width: 280px;
            background: rgba(255,255,255,0.95);
            border: 1px solid rgba(255,255,255,0.8);
            border-radius: 20px;
            box-shadow: 
                0 20px 40px rgba(15,23,42,.08),
                0 8px 16px rgba(15,23,42,.04),
                inset 0 1px 0 rgba(255,255,255,0.9);
            padding: 24px;
            height: calc(100vh - 40px);
            position: sticky;
            top: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(20px);
        }
        
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .sidebar-title {
            font-size: 20px;
            font-weight: 800;
            background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .schedule-manage-btn {
            padding: 6px 12px;
            background: linear-gradient(135deg, var(--brand), var(--brand-2));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 6px rgba(37,99,235,0.2);
            white-space: nowrap;
            display: none; /* 默认隐藏，只有用户名为admin时显示 */
        }

        .schedule-manage-btn.show {
            display: block;
        }

        .schedule-manage-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(37,99,235,0.3);
        }

        /* 采购单编号筛选框样式 */
        .invoice-search-box {
            margin-bottom: 16px;
            flex-shrink: 0;
        }

        .invoice-search-box input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--line);
            border-radius: 12px;
            font-size: 14px;
            background: rgba(255,255,255,0.8);
            transition: all 0.3s ease;
        }

        .invoice-search-box input:focus {
            outline: none;
            border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
            background: rgba(255,255,255,0.95);
        }

        .invoice-search-box input::placeholder {
            color: var(--muted);
        }

        /* 任务统计区域 */
        .task-statistics {
            margin-bottom: 16px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(59,130,246,0.05), rgba(168,85,247,0.05));
            border: 1px solid rgba(59,130,246,0.15);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }

        .task-breakdown {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .task-stat-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 10px;
            background: rgba(255,255,255,0.7);
            border-radius: 10px;
            font-size: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .task-stat-item:hover {
            background: rgba(255,255,255,0.95);
            transform: translateX(4px);
            border-color: rgba(59,130,246,0.2);
        }

        .task-stat-item.active {
            background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(37,99,235,0.15));
            border-color: var(--brand);
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(59,130,246,0.2);
        }

        .task-stat-item.active .task-stat-label {
            color: var(--brand);
            font-weight: 700;
        }

        .task-stat-item.active .task-stat-number {
            color: var(--brand);
            font-weight: 900;
        }

        .task-stat-label {
            color: var(--text-light);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .task-stat-number {
            font-weight: 800;
            font-size: 14px;
        }

        .task-stat-item.running .task-stat-number {
            color: #d97706;
        }

        .task-stat-item.completed-first .task-stat-number {
            color: #059669;
        }

        .task-stat-item.completed-second .task-stat-number {
            color: #10b981;
        }

        .task-stat-item.finished .task-stat-number {
            color: #16a34a;
        }

        .task-stat-item.error .task-stat-number {
            color: #dc2626;
        }
        
        #sidebar-content {
            flex: 1 1 auto;
            overflow-y: auto !important;
            overflow-x: hidden;
            min-height: 0;
            max-height: 100%;
            padding-right: 8px;
        }
        
        .sidebar-item {
            width: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            border-radius: 14px;
            background: rgba(248,250,252,0.8);
            border: 1px solid rgba(226,232,240,0.6);
            margin-bottom: 12px;
            padding: 14px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .sidebar-item:hover {
            background: rgba(241,245,249,0.9);
            transform: translateX(8px);
            box-shadow: 0 8px 16px rgba(15,23,42,0.08);
            border-color: rgba(59,130,246,0.3);
        }
        
        .sidebar-item.active {
            background: linear-gradient(135deg, var(--brand), var(--brand-2));
            color: white;
            border-color: var(--brand);
            box-shadow: 
                0 8px 16px rgba(37,99,235,0.25),
                0 4px 8px rgba(37,99,235,0.15);
        }
        
        .sidebar-item-title {
            width: 100%;
            font-size: 15px;
            font-weight: 600;
            line-height: 22px;
            color: var(--text);
        }
        
        .sidebar-item.active .sidebar-item-title,
        .sidebar-item.active .sidebar-item-stat,
        .sidebar-item.active .sidebar-item-conductor {
            color: white;
        }
        
        .sidebar-item-info {
            width: 100%;
            display: flex;
            flex-direction: column;
            margin-top: 8px;
        }
        
        .sidebar-item-stat {
            font-size: 13px;
            font-weight: 400;
            color: var(--text-light);
            margin-bottom: 4px;
        }
        
        .sidebar-item-conductor {
            font-size: 12px;
            font-weight: 400;
            color: var(--muted);
        }
        
        .content-container {
            flex: 1;
            min-width: 0;
        }
        
        .container {
            width: 100%;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .header-left h1 {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .system-help-button {
            background: linear-gradient(135deg, var(--brand), var(--brand-2));
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(37,99,235,0.2);
        }

        .system-help-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(37,99,235,0.3);
        }

        .help-popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            backdrop-filter: blur(8px);
        }

        .help-popup-overlay.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .help-popup {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            box-shadow: 
                0 25px 50px rgba(15,23,42,.15),
                0 12px 20px rgba(15,23,42,.08);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.8);
        }

        .help-popup-header {
            background: linear-gradient(135deg, rgba(248,250,252,.9), rgba(241,245,249,.6));
            padding: 24px;
            border-bottom: 1px solid var(--line);
            border-radius: 20px 20px 0 0;
        }

        .help-popup-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text);
        }

        .help-popup-close {
            position: absolute;
            top: 20px;
            right: 24px;
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--muted);
            transition: color 0.2s;
        }

        .help-popup-close:hover {
            color: var(--error);
        }

        .help-popup-content {
            padding: 24px;
            line-height: 1.8;
        }

        .help-section {
            margin-bottom: 24px;
        }

        .help-section-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--brand);
            margin-bottom: 12px;
            padding-left: 12px;
            border-left: 4px solid var(--brand);
        }

        .help-section-content {
            color: var(--text);
            margin-left: 16px;
        }

        .help-list {
            margin: 10px 0;
            padding-left: 24px;
        }

        .help-list li {
            margin-bottom: 8px;
        }

        /* 排班管理弹窗样式 */
        .schedule-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2001;
            backdrop-filter: blur(8px);
        }

        .schedule-modal-overlay.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .schedule-modal {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            box-shadow: 
                0 25px 50px rgba(15,23,42,.15),
                0 12px 20px rgba(15,23,42,.08);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.8);
        }

        .schedule-modal-header {
            background: linear-gradient(135deg, rgba(248,250,252,.9), rgba(241,245,249,.6));
            padding: 24px;
            border-bottom: 1px solid var(--line);
            border-radius: 20px 20px 0 0;
            position: relative;
        }

        .schedule-modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text);
        }

        .schedule-modal-desc {
            font-size: 13px;
            color: var(--muted);
            margin-top: 8px;
        }

        .schedule-modal-close {
            position: absolute;
            top: 20px;
            right: 24px;
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--muted);
            transition: color 0.2s;
        }

        .schedule-modal-close:hover {
            color: var(--error);
        }

        .schedule-modal-content {
            padding: 24px;
        }

        .schedule-date-selector {
            margin-bottom: 24px;
        }

        .schedule-date-group {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .schedule-date-label {
            font-size: 14px;
            color: var(--text-light);
            font-weight: 500;
            min-width: 80px;
        }

        .schedule-date-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--line);
            border-radius: 10px;
            font-size: 14px;
            background: rgba(255,255,255,0.8);
            transition: all 0.3s;
        }

        .schedule-date-input:focus {
            outline: none;
            border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
        }

        .schedule-quick-select {
            display: flex;
            gap: 8px;
        }

        .quick-date-btn {
            padding: 6px 12px;
            border: 1px solid var(--line);
            border-radius: 8px;
            font-size: 12px;
            background: var(--card);
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-date-btn:hover {
            border-color: var(--brand);
            color: var(--brand);
            background: var(--brand-light);
        }

        .schedule-staff-section {
            margin-bottom: 24px;
        }

        .schedule-staff-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--line);
        }

        .schedule-staff-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text);
        }

        .schedule-staff-actions {
            display: flex;
            gap: 8px;
        }

        .schedule-action-btn {
            padding: 4px 12px;
            font-size: 12px;
            border: 1px solid var(--line);
            background: var(--card);
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-light);
            transition: all 0.2s;
        }

        .schedule-action-btn:hover {
            border-color: var(--brand);
            color: var(--brand);
            background: var(--brand-light);
        }

        .schedule-staff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
        }

        .schedule-staff-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border: 1px solid var(--line);
            border-radius: 10px;
            background: var(--bg);
            cursor: pointer;
            transition: all 0.2s;
        }

        .schedule-staff-checkbox:hover {
            border-color: var(--brand);
            background: var(--brand-light);
        }

        .schedule-staff-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--brand);
        }

        .schedule-staff-checkbox label {
            flex: 1;
            cursor: pointer;
            font-size: 14px;
            color: var(--text);
        }

        .schedule-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--line);
            background: var(--bg-2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 0 0 20px 20px;
        }

        .schedule-info {
            font-size: 13px;
            color: var(--text-light);
        }

        .schedule-info strong {
            color: var(--brand);
            font-weight: 600;
        }

        .schedule-btn-group {
            display: flex;
            gap: 12px;
        }

        .schedule-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .schedule-btn-secondary {
            background: var(--card);
            border: 1px solid var(--line);
            color: var(--text);
        }

        .schedule-btn-secondary:hover {
            background: var(--bg);
        }

        .schedule-btn-primary {
            background: linear-gradient(135deg, var(--brand), var(--brand-2));
            color: white;
            box-shadow: 0 4px 8px rgba(37,99,235,0.2);
        }

        .schedule-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(37,99,235,0.3);
        }

        .schedule-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .schedule-loading {
            text-align: center;
            padding: 20px;
            color: var(--muted);
        }
        
        .login-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            animation: slideIn 0.8s ease-out;
        }
        
        .login-container {
            background: rgba(255,255,255,0.95);
            padding: 32px;
            border-radius: 20px;
            box-shadow: 
                0 20px 40px rgba(15,23,42,.08),
                0 8px 16px rgba(15,23,42,.04),
                inset 0 1px 0 rgba(255,255,255,0.9);
            margin-bottom: 20px;
            width: 100%;
            max-width: 500px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.8);
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-title {
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .form-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-item label {
            font-size: 14px;
            font-weight: 600;
            color: var(--muted);
        }
        
        .form-item input {
            padding: 14px 16px;
            border: 1px solid var(--line);
            border-radius: 12px;
            font-size: 15px;
            background: rgba(255,255,255,0.8);
            transition: all 0.3s;
        }

        .form-item input:focus {
            outline: none;
            border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
            background: rgba(255,255,255,0.95);
        }
        
        .btn {
            padding: 14px 20px;
            background: linear-gradient(135deg, var(--brand-2), var(--brand));
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 700;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(37,99,235,0.2);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(37,99,235,0.3);
        }
        
        .task-page {
            display: none;
        }
        
        .task-block {
            background: rgba(255,255,255,0.95);
            border: 1px solid rgba(255,255,255,0.8);
            border-radius: 20px;
            box-shadow: 
                0 20px 40px rgba(15,23,42,.08),
                0 8px 16px rgba(15,23,42,.04),
                inset 0 1px 0 rgba(255,255,255,0.9);
            margin-bottom: 24px;
            overflow: hidden;
            backdrop-filter: blur(20px);
        }
        
        .task-header {
            background: linear-gradient(135deg, rgba(248,250,252,.9), rgba(241,245,249,.6));
            padding: 20px 28px;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid var(--line);
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
        }
        
        .task-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            flex: 1;
            min-width: 0;
        }
        
        .task-header-right {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .task-details-info {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            padding: 8px 0;
        }

        .task-detail-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-light);
            white-space: nowrap;
        }

        .task-detail-label {
            color: var(--muted);
            font-weight: 500;
        }

        .task-detail-value {
            color: var(--text);
            font-weight: 600;
        }

        .purchase-status-dropdown {
            position: relative;
            display: inline-block;
        }

        .purchase-status-button {
            padding: 6px 14px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--info), #5b21b6);
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            border: none;
            min-width: 100px;
            box-shadow: 0 4px 8px rgba(99,102,241,0.2);
            transition: all 0.3s;
        }

        .purchase-status-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(99,102,241,0.3);
        }

        .purchase-status-options {
            position: absolute;
            top: 100%;
            left: 0;
            background: rgba(255,255,255,0.95);
            border: 1px solid var(--line);
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(15,23,42,0.15);
            z-index: 1000;
            min-width: 140px;
            display: none;
            backdrop-filter: blur(20px);
            margin-top: 4px;
        }

        .purchase-status-options.show {
            display: block;
        }

        .purchase-status-option {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text);
            border-bottom: 1px solid var(--line);
            transition: all 0.2s;
        }

        .purchase-status-option:last-child {
            border-bottom: none;
        }

        .purchase-status-option:hover {
            background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(168,85,247,0.1));
        }
        
        .task-status {
            display: inline-block;
            padding: 6px 12px;
            background: var(--brand-light);
            color: var(--brand);
            border-radius: 10px;
            margin-right: 12px;
            font-weight: 600;
        }
        
        .task-time {
            color: var(--muted);
            white-space: nowrap;
            font-weight: 500;
        }
        
        .task-content {
            padding: 28px;
        }
        
        .feedback-container {
            border: 1px solid var(--line);
            border-radius: 16px;
            margin-bottom: 24px;
            background: rgba(248,250,252,0.5);
        }
        
        .feedback-header {
            background: linear-gradient(135deg, rgba(248,250,252,.9), rgba(241,245,249,.6));
            padding: 16px 24px;
            border-bottom: 1px solid var(--line);
            font-weight: 700;
        }
        
        .feedback-content {
            padding: 16px 24px;
        }
        
        .feedback-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--line);
        }
        
        .feedback-item:last-child {
            border-bottom: none;
        }
        
        .feedback-user {
            font-weight: 700;
            margin-right: 12px;
        }
        
        .feedback-time {
            color: var(--muted);
            font-size: 12px;
        }
        
        .feedback-info {
            margin-top: 8px;
        }

        .feedback-edit-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255,255,255,0.8);
            border-radius: 12px;
            border: 1px solid var(--line);
        }

        .feedback-edit-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 12px;
        }

        .feedback-textarea {
            width: 100%;
            min-height: 100px;
            padding: 14px;
            border: 1px solid var(--line);
            border-radius: 12px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 12px;
            background: rgba(255,255,255,0.9);
            transition: all 0.3s;
        }

        .feedback-textarea:focus {
            outline: none;
            border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
        }

        .feedback-submit-btn {
            background: linear-gradient(135deg, var(--brand), var(--brand-2));
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(37,99,235,0.2);
        }

        .feedback-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(37,99,235,0.3);
        }

        .feedback-submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .orders-container {
            margin-top: 24px;
        }
        
        .order-item {
            border: 1px solid var(--line);
            border-radius: 16px;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.8);
            transition: all 0.3s;
        }

        .order-item:hover {
            box-shadow: 0 8px 16px rgba(15,23,42,0.08);
        }

        .order-item.collapsed {
            display: none;
        }
        
        .order-content {
            padding: 20px 24px;
        }
        
        .order-header-info {
            margin-bottom: 20px;
        }

        .order-header-title {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            gap: 12px;
        }

        .order-checkbox {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .order-header-row {
            display: flex;
            flex-wrap: wrap;
            background: linear-gradient(135deg, rgba(248,250,252,0.8), rgba(241,245,249,0.5));
            padding: 16px;
            border-radius: 12px;
            align-items: center;
            gap: 16px;
        }
        
        .order-header-item {
            margin-right: 24px;
        }
        
        .order-header-item .label {
            color: var(--muted);
            font-size: 13px;
            margin-right: 6px;
            font-weight: 500;
        }
        
        .order-header-item .value {
            color: var(--text);
            font-size: 13px;
            font-weight: 600;
        }
        
        .order-header-item .value a {
            color: var(--brand);
            text-decoration: none;
            font-weight: 600;
        }
        
        .order-header-item .value a:hover {
            text-decoration: underline;
        }
        
        .purchase-container {
            border: 1px solid var(--line);
            border-radius: 16px;
            margin-bottom: 24px;
            background: rgba(255,255,255,0.8);
            overflow: hidden;
        }
        
        .purchase-header {
            background: linear-gradient(135deg, rgba(248,250,252,.9), rgba(241,245,249,.6));
            padding: 16px 24px;
            border-bottom: 1px solid var(--line);
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        /* 采购单复选框样式 */
        .purchase-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            margin-right: 12px;
        }
        
        .purchase-content {
            padding: 20px 24px;
        }
        
        .purchase-info-row {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 12px;
            gap: 20px;
        }
        
        .purchase-info-item {
            margin-right: 24px;
        }
        
        .purchase-info-item .label {
            color: var(--muted);
            font-size: 13px;
            margin-right: 6px;
            font-weight: 500;
        }
        
        .purchase-info-item .value {
            color: var(--text);
            font-size: 13px;
            font-weight: 600;
        }
        
        .products-container {
            border: 1px solid var(--line);
            border-radius: 12px;
        }
        
        .product-row {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--line);
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .product-row:last-child {
            border-bottom: none;
        }
        
        .product-image-container {
            width: 60px;
            flex-shrink: 0;
            margin-right: 16px;
        }
        
        .product-image {
            width: 48px;
            height: 48px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .product-info-container {
            flex: 1;
            margin-right: 20px;
            min-width: 200px;
        }
        
        .product-title {
            font-size: 14px;
            margin-bottom: 6px;
            color: var(--text);
            line-height: 1.5;
            font-weight: 500;
        }
        
        .product-variant-info {
            display: inline;
            margin-left: 12px;
        }
        
        .variant-label, .quantity-label, .link-label, .status-label, .sku-label, .check-status-label, .transfer-status-label {
            color: var(--muted);
            font-size: 12px;
            margin-right: 8px;
        }
        
        .variant-value, .quantity-value, .link-value, .status-value, .sku-value, .check-status-value, .transfer-status-value {
            color: var(--text);
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-value.failed {
            color: var(--error);
        }
        
        .status-value.success {
            color: var(--success);
        }
        
        .status-value.pending {
            color: var(--warning);
        }
        
        .product-quantity, .product-link, .product-sku, .product-transfer-status, .product-check-status, .product-actions {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            margin-right: 16px;
        }
        
        .product-link a {
            color: var(--brand);
            text-decoration: none;
            font-weight: 600;
        }
        
        .product-link a:hover {
            text-decoration: underline;
        }
        
        .detail-btn {
            background: linear-gradient(135deg, var(--brand), var(--brand-2));
            color: white;
            border: none;
            border-radius: 8px;
            padding: 6px 14px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(37,99,235,0.2);
        }
        
        .detail-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(37,99,235,0.3);
        }
        
        .user-bar {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .username {
            font-weight: 700;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            font-style: italic;
            color: var(--muted);
            font-size: 16px;
        }
        
        .error {
            color: var(--error);
            padding: 16px;
            border: 1px solid var(--error-light);
            background: linear-gradient(135deg, rgba(254,202,202,0.5), rgba(252,165,165,0.3));
            border-radius: 12px;
            font-weight: 600;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: var(--muted);
            font-style: italic;
        }
        
        .order-all-purchased {
            text-align: center;
            padding: 20px;
            color: var(--success);
            font-weight: 600;
            background: var(--success-light);
            border: 1px solid var(--success);
            border-radius: 12px;
            margin: 16px 0;
        }
        
        .product-detail-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 1328px;
            max-height: 80vh;
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            box-shadow: 
                0 25px 50px rgba(15,23,42,.15),
                0 12px 20px rgba(15,23,42,.08);
            z-index: 1000;
            overflow-y: auto;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.8);
        }
        
        .product-detail-popup.active {
            display: block;
        }
        
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            backdrop-filter: blur(8px);
        }
        
        .popup-overlay.active {
            display: block;
        }
        
        .popup-close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(255,255,255,0.9);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            color: var(--muted);
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(15,23,42,0.1);
        }

        .popup-close-btn:hover {
            background: var(--error-light);
            color: var(--error);
            transform: rotate(90deg);
        }
        
        .detail-popup-container {
            padding: 40px;
        }
        
        .detail-row-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 24px;
        }
        
        .detail-left-column, .detail-right-column {
            width: 48%;
            min-width: 300px;
        }
        
        .detail-right-column {
            border-left: 1px solid var(--line);
            padding-left: 32px;
        }
        
        .detail-info-row {
            margin-bottom: 16px;
            display: flex;
        }
        
        .detail-label {
            color: var(--muted);
            font-size: 14px;
            width: 120px;
            flex-shrink: 0;
            font-weight: 600;
        }
        
        .detail-value {
            color: var(--text);
            font-size: 14px;
            flex: 1;
            font-weight: 500;
        }
        
        #popup-special-pairing {
            white-space: pre-line;
            max-height: 150px;
            overflow-y: auto;
        }

        .task-number {
            font-size: 16px;
            font-weight: 700;
            margin-right: 12px;
            white-space: nowrap;
        }

        .intention-code {
            font-size: 14px;
            color: var(--text-light);
            white-space: nowrap;
            font-weight: 500;
        }
        
        .status-running {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, var(--warning-light), var(--warning));
            border-radius: 12px;
            padding: 6px 12px 6px 30px;
            position: relative;
            font-weight: 600;
        }
        
        .status-running img {
            width: 16px;
            height: 16px;
            position: absolute;
            left: 8px;
        }
        
        .status-running span {
            font-size: 13px;
            color: var(--text);
        }
        
        .status-completed {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, var(--success-light), var(--success));
            border-radius: 12px;
            padding: 6px 12px 6px 30px;
            position: relative;
            font-weight: 600;
        }
        
        .status-completed img {
            width: 16px;
            height: 16px;
            position: absolute;
            left: 8px;
        }
        
        .status-completed span {
            font-size: 13px;
            color: var(--text);
        }

        .status-finished {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, var(--success-light), var(--success));
            border-radius: 12px;
            padding: 6px 12px 6px 30px;
            position: relative;
            font-weight: 600;
        }
        
        .status-finished img {
            width: 16px;
            height: 16px;
            position: absolute;
            left: 8px;
        }
        
        .status-finished span {
            font-size: 13px;
            color: var(--text);
        }

        .music_155_20577 {
            position: relative;
            width: 100%;
            border-radius: 16px;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 4px 8px rgba(15,23,42,0.08);
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
            border: 1px solid var(--line);
        }

        .music_155_20628 {
            width: 100%;
            font-size: 16px;
            font-weight: 700;
            line-height: 24px;
            color: var(--text);
            padding: 16px 20px;
        }

        .music_155_20634 {
            width: 100%;
            max-height: 230px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding-left: 20px;
            gap: 8px;
            border-left: 2px solid var(--line);
            margin: 12px 0;
        }

        .music_155_20670, .music_155_20635 {
            position: relative;
            width: calc(100% - 20px);
            display: flex;
            margin-bottom: 12px;
        }

        .music_155_20671, .music_155_20669 {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            position: relative;
            margin-left: -26px;
            margin-top: 8px;
            flex-shrink: 0;
        }

        .music_155_20671 {
            background: var(--brand);
        }

        .music_155_20669 {
            background: var(--muted);
        }

        .music_155_20672, .music_155_20636 {
            width: 100%;
            display: flex;
            gap: 10px;
            margin-left: 12px;
        }

        .music_155_20693, .music_155_20663 {
            width: 28px;
            height: 28px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            border-radius: 50%;
            font-size: 13px;
            font-weight: 600;
        }

        .music_155_20693 {
            background: var(--brand);
            color: white;
        }

        .music_155_20663 {
            background: var(--bg-2);
            color: var(--text-light);
        }

        .music_155_20673, .music_155_20637 {
            width: calc(100% - 38px);
            display: flex;
            flex-direction: column;
        }

        .music_155_20682, .music_155_20657 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        .music_155_20674, .music_155_20638 {
            font-size: 13px;
            color: var(--text-light);
            margin-top: 4px;
            line-height: 1.6;
        }

        .music_155_20674 img, .music_155_20638 img {
            max-width: 200px;
            max-height: 150px;
            margin: 8px 0;
            border-radius: 8px;
            border: 1px solid var(--line);
        }

        .music_155_20688, .music_155_20652 {
            font-size: 12px;
            color: var(--muted);
            margin-top: 6px;
        }
        
        .toast {
            position: fixed;
            top: 24px;
            right: 24px;
            background: var(--text);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s;
            max-width: 350px;
            font-weight: 600;
            box-shadow: 0 8px 16px rgba(15,23,42,0.2);
        }
        
        .toast.success {
            background: linear-gradient(135deg, var(--success), #059669);
        }
        
        .toast.error {
            background: linear-gradient(135deg, var(--error), #dc2626);
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast:not(.show) {
            transform: translateY(-20px);
        }

        .refresh-button, .toggle-orders-button, .purchase-wait-button, .check-orders-button {
            position: relative;
            display: inline-block;
            margin-right: 12px;
        }

        .refresh-button-inner, .toggle-orders-button-inner, .purchase-wait-button-inner, .check-orders-button-inner {
            padding: 8px 16px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--brand), var(--brand-2));
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(37,99,235,0.2);
            transition: all 0.3s;
        }

        .refresh-button-inner:hover, .toggle-orders-button-inner:hover, .purchase-wait-button-inner:hover, .check-orders-button-inner:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(37,99,235,0.3);
        }

        .check-orders-button-inner.disabled {
            background: var(--muted);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .purchase-dropdown, .check-dropdown, .payment-link-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: rgba(255,255,255,0.95);
            border: 1px solid var(--line);
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(15,23,42,0.15);
            z-index: 1000;
            min-width: 180px;
            display: none;
            backdrop-filter: blur(20px);
            margin-top: 4px;
        }

        .purchase-dropdown.show, .check-dropdown.show, .payment-link-dropdown.show {
            display: block;
        }

        .purchase-dropdown-item, .check-dropdown-item, .payment-link-dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text);
            border-bottom: 1px solid var(--line);
            transition: all 0.2s;
            font-weight: 500;
        }

        .purchase-dropdown-item:last-child, .check-dropdown-item:last-child, .payment-link-dropdown-item:last-child {
            border-bottom: none;
        }

        .purchase-dropdown-item:hover, .check-dropdown-item:hover, .payment-link-dropdown-item:hover {
            background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(168,85,247,0.1));
        }

        .complete-task-btn {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 12px;
            box-shadow: 0 4px 8px rgba(16,185,129,0.2);
        }

        .complete-task-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(16,185,129,0.3);
        }

        .complete-task-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(8px);
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top: 5px solid var(--brand);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .purchase-products {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }
        
        .purchase-product-item {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            padding: 16px;
            border: 1px solid var(--line);
            border-radius: 12px;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 2px 4px rgba(15,23,42,0.05);
            transition: all 0.3s;
            gap: 12px;
        }
        
        .purchase-product-item:hover {
            box-shadow: 0 4px 8px rgba(15,23,42,0.1);
            transform: translateY(-2px);
        }
        
        .purchase-product-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            background: var(--bg-2);
            flex-shrink: 0;
        }
        
        .purchase-product-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 0;
        }
        
        .purchase-product-name {
            font-size: 13px;
            font-weight: 600;
            line-height: 1.4;
            color: var(--text);
            margin-bottom: 0;
            min-height: 36px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .purchase-product-sku {
            font-size: 11px;
            font-weight: 400;
            color: var(--text-light);
        }
        
        .purchase-product-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 12px;
        }
        
        .purchase-product-quantity {
            color: var(--text-light);
            font-size: 13px;
            font-weight: 600;
        }
        
        .purchase-product-price {
            color: var(--brand);
            font-size: 14px;
            font-weight: 700;
        }
        
        .view-1688-btn {
            display: inline-block;
            padding: 8px 14px;
            background: linear-gradient(135deg, var(--brand), var(--brand-2));
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s;
            margin-top: auto;
            box-shadow: 0 2px 4px rgba(37,99,235,0.2);
        }
        
        .view-1688-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(37,99,235,0.3);
        }
        
        .no-1688-link {
            display: inline-block;
            padding: 8px 14px;
            background: var(--bg-2);
            color: var(--muted);
            border-radius: 8px;
            font-size: 12px;
            text-align: center;
            margin-top: auto;
        }
        
        .request-counter {
            position: fixed;
            bottom: 24px;
            left: 24px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 12px;
            z-index: 1000;
            display: none;
            backdrop-filter: blur(10px);
        }
        
        .request-counter.show {
            display: block;
        }
        
        .request-counter.warning {
            background: linear-gradient(135deg, var(--error), #dc2626);
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 20px;
            padding: 12px 0;
        }

        /* 采购单信息标题和按钮容器 */
        .purchase-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 16px;
            flex-wrap: wrap;
        }

        .purchase-section-header .section-title {
            margin-bottom: 0;
            flex: 1;
        }

        .payment-link-button {
            position: relative;
            display: inline-block;
        }

        .payment-link-button-inner {
            padding: 8px 16px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--brand), var(--brand-2));
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(37,99,235,0.2);
            transition: all 0.3s;
            white-space: nowrap;
        }

        .payment-link-button-inner:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(37,99,235,0.3);
        }

        .order-status-text {
            display: inline-block;
            padding: 8px 14px;
            background: var(--bg-2);
            color: var(--text-light);
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .purchase-error-info {
            margin-top: 12px;
            padding: 12px;
            background: var(--error-light);
            border: 1px solid var(--error);
            border-radius: 10px;
            color: var(--error);
            font-size: 12px;
            line-height: 1.5;
        }

        .purchase-error-title {
            font-weight: 700;
            margin-bottom: 6px;
        }

        .purchase-remark-info {
            margin-top: 16px;
            padding: 14px;
            background: rgba(248,250,252,0.8);
            border: 1px solid var(--line);
            border-radius: 10px;
            border-left: 4px solid var(--brand);
        }

        .purchase-remark-title {
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .purchase-remark-content {
            color: var(--text-light);
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .buyer-message-info {
            margin-top: 16px;
            padding: 14px;
            background: var(--warning-light);
            border: 1px solid var(--warning);
            border-radius: 10px;
            border-left: 4px solid var(--warning);
        }

        .buyer-message-title {
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .buyer-message-content {
            color: var(--text-light);
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* 付款链接弹窗 */
        .payment-link-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            box-shadow: 
                0 25px 50px rgba(15,23,42,.15),
                0 12px 20px rgba(15,23,42,.08);
            z-index: 2000;
            width: 90%;
            max-width: 500px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.8);
        }

        .payment-link-modal.active {
            display: block;
        }

        .payment-link-modal-header {
            background: linear-gradient(135deg, rgba(248,250,252,.9), rgba(241,245,249,.6));
            padding: 24px;
            border-bottom: 1px solid var(--line);
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .payment-link-modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text);
        }

        .payment-link-modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--muted);
            transition: color 0.2s;
        }

        .payment-link-modal-close:hover {
            color: var(--error);
        }

        .payment-link-modal-content {
            padding: 24px;
        }

        .payment-link-error {
            color: var(--error);
            line-height: 1.8;
            font-size: 14px;
        }

        .payment-link-success {
            text-align: center;
        }

        .payment-link-text {
            color: var(--text);
            margin-bottom: 20px;
            font-size: 14px;
        }

        .payment-link-url {
            display: block;
            padding: 14px 20px;
            background: linear-gradient(135deg, var(--brand), var(--brand-2));
            color: white;
            text-decoration: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(37,99,235,0.2);
        }

        .payment-link-url:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(37,99,235,0.3);
        }

        .order-btn {
            background: linear-gradient(135deg, var(--brand), var(--brand-2));
            color: white;
            border: none;
            border-radius: 10px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(37,99,235,0.2);
        }

        .order-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(37,99,235,0.3);
        }
        
        @media (max-width: 1200px) {
            .sidebar {
                width: 25%;
                min-width: 250px;
            }

            .purchase-products {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 960px) {
            .main-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                position: static;
                margin-bottom: 24px;
                height: 300px;
            }

            #sidebar-content {
                max-height: 200px;
            }
            
            .task-header-left {
                flex: 1 1 100%;
            }
            
            .task-header-right {
                flex: 1 1 100%;
            }
            
            .product-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .detail-left-column, .detail-right-column {
                width: 100%;
                border-left: none;
                padding-left: 0;
            }
            
            .detail-right-column {
                border-top: 1px solid var(--line);
                padding-top: 20px;
                margin-top: 20px;
            }

            .purchase-products {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 640px) {
            body {
                padding: 12px;
            }
            
            .task-content {
                padding: 20px;
            }

            .sidebar {
                padding: 20px;
            }

            .header-left h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div id="sidebar" class="sidebar" style="display: none;">
            <div class="sidebar-header">
                <div class="sidebar-title">任务目录</div>
                <button class="schedule-manage-btn" id="schedule-manage-btn" onclick="openScheduleModal()">📅 排班</button>
            </div>
            
            <!-- 采购单编号筛选框 -->
            <div class="invoice-search-box">
                <input type="text" id="invoiceSearchInput" placeholder="搜索采购单编号..." oninput="filterByInvoiceCode()">
            </div>

            <!-- 任务统计区域 -->
            <div class="task-statistics">
                <div class="task-breakdown">
                    <div class="task-stat-item running" onclick="selectCategory('running')">
                        <span class="task-stat-label">运行中</span>
                        <span class="task-stat-number" id="runningCount">0</span>
                    </div>
                    <div class="task-stat-item waiting" onclick="selectCategory('waiting')">
                        <span class="task-stat-label">等待</span>
                        <span class="task-stat-number" id="waitingCount">0</span>
                    </div>
                    <div class="task-stat-item completed-first" onclick="selectCategory('completed-first')">
                        <span class="task-stat-label">已完成-首次</span>
                        <span class="task-stat-number" id="completedFirstCount">0</span>
                    </div>
                    <div class="task-stat-item completed-second" onclick="selectCategory('completed-second')">
                        <span class="task-stat-label">已完成-二次</span>
                        <span class="task-stat-number" id="completedSecondCount">0</span>
                    </div>
                    <div class="task-stat-item finished" onclick="selectCategory('finished')">
                        <span class="task-stat-label">采购完结</span>
                        <span class="task-stat-number" id="finishedCount">0</span>
                    </div>
                    <div class="task-stat-item error" onclick="selectCategory('error')">
                        <span class="task-stat-label">异常</span>
                        <span class="task-stat-number" id="errorCount">0</span>
                    </div>
                </div>
            </div>
            
            <div id="sidebar-content"></div>
        </div>
        
        <div class="content-container">
            <div class="container">
                <div class="header">
                    <div class="header-left">
                        <h1>采购IW</h1>
                    </div>
                    <div id="user-bar" class="user-bar" style="display: none;">
                        <button class="system-help-button" onclick="showHelpPopup()">点击查看说明</button>
                        <span class="username" id="username-display"></span>
                        <button id="logout-btn" class="btn">退出登录</button>
                    </div>
                </div>
                
                <div id="login-page" class="login-page">
                    <div class="login-container">
                        <div class="form-title">用户登录</div>
                        <div class="login-form">
                            <div class="form-item">
                                <label for="username">用户名</label>
                                <input type="text" id="username" placeholder="请输入用户名" value="">
                            </div>
                            <div class="form-item">
                                <label for="password">密码</label>
                                <input type="password" id="password" placeholder="请输入密码" value="">
                            </div>
                            <button id="login-btn" class="btn">登录</button>
                        </div>
                    </div>
                </div>
                
                <div id="task-page" class="task-page">
                    <div id="task-list" class="task-list"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="popup-overlay" class="popup-overlay"></div>
    <div id="product-detail-popup" class="product-detail-popup">
        <button id="popup-close-btn" class="popup-close-btn">&times;</button>
        <div class="detail-popup-container">
            <div class="detail-row-container">
                <div class="detail-left-column">
                    <div class="detail-info-row">
                        <div class="detail-label">店铺编号:</div>
                        <div class="detail-value" id="popup-shop-num"></div>
                    </div>
                    <div class="detail-info-row">
                        <div class="detail-label">运单号:</div>
                        <div class="detail-value" id="popup-waybill-num"></div>
                    </div>
                    <div class="detail-info-row">
                        <div class="detail-label">订单备注:</div>
                        <div class="detail-value" id="popup-huo-remark"></div>
                    </div>
                    <div class="detail-info-row">
                        <div class="detail-label">店小秘SKU:</div>
                        <div class="detail-value" id="popup-product-sku-info"></div>
                    </div>
                    <div class="detail-info-row">
                        <div class="detail-label">1688SKU字段:</div>
                        <div class="detail-value" id="popup-ali-sku"></div>
                    </div>
                    <div class="detail-info-row">
                        <div class="detail-label">付款状态:</div>
                        <div class="detail-value" id="popup-pay-status"></div>
                    </div>
                </div>
                <div class="detail-right-column">
                    <div class="detail-info-row">
                        <div class="detail-label">收件人:</div>
                        <div class="detail-value" id="popup-name"></div>
                    </div>
                    <div class="detail-info-row">
                        <div class="detail-label">邮箱:</div>
                        <div class="detail-value" id="popup-email"></div>
                    </div>
                    <div class="detail-info-row">
                        <div class="detail-label">地址:</div>
                        <div class="detail-value" id="popup-addr"></div>
                    </div>
                    <div class="detail-info-row">
                        <div class="detail-label">城市:</div>
                        <div class="detail-value" id="popup-city"></div>
                    </div>
                    <div class="detail-info-row">
                        <div class="detail-label">邮编:</div>
                        <div class="detail-value" id="popup-postcode"></div>
                    </div>
                    <div class="detail-info-row">
                        <div class="detail-label">省份:</div>
                        <div class="detail-value" id="popup-province"></div>
                    </div>
                    <div class="detail-info-row">
                        <div class="detail-label">电话:</div>
                        <div class="detail-value" id="popup-phone"></div>
                    </div>
                </div>
            </div>
            
            <div class="detail-additional-info">
                <div class="detail-info-row">
                    <div class="detail-label">包装号:</div>
                    <div class="detail-value" id="popup-package-id"></div>
                </div>
                <div class="detail-info-row">
                    <div class="detail-label">特殊备注:</div>
                    <div class="detail-value" id="popup-shipments-remark"></div>
                </div>
                <div class="detail-info-row">
                    <div class="detail-label">1688买家留言:</div>
                    <div class="detail-value" id="popup-ali-buyer-word"></div>
                </div>
                <div class="detail-info-row">
                    <div class="detail-label">采购单备注:</div>
                    <div class="detail-value" id="popup-purchase-remark"></div>
                </div>
                
                <div class="detail-info-row">
                    <div class="detail-label">产品拣货备注:</div>
                    <div class="detail-value" id="popup-remark"></div>
                </div>
                
                <div class="detail-info-row">
                    <div class="detail-label">特殊配对:</div>
                    <div class="detail-value" id="popup-special-pairing"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="help-popup-overlay" class="help-popup-overlay" onclick="hideHelpPopup()">
        <div class="help-popup" onclick="event.stopPropagation()">
            <div class="help-popup-header">
                <h3 class="help-popup-title">系统操作说明</h3>
                <button class="help-popup-close" onclick="hideHelpPopup()">&times;</button>
            </div>
            <div class="help-popup-content">
                <div class="help-section">
                    <div class="help-section-title">任务分类</div>
                    <div class="help-section-content">
                        处理状态=待采购,处理人≠空值
                    </div>
                </div>
                
                <div class="help-section">
                    <div class="help-section-title">1688订单匹配</div>
                    <div class="help-section-content">
                        <ol class="help-list">
                            <li>系统根据运单号查询店小秘SKU以及店小秘包裹号</li>
                            <li>使用包裹号进行1688订单配对</li>
                        </ol>
                    </div>
                </div>
                
                <div class="help-section">
                    <div class="help-section-title">转仓操作</div>
                    <div class="help-section-content">
                        点击"等待采购"可执行移仓转仓操作
                    </div>
                </div>
                
                <div class="help-section">
                    <div class="help-section-title">下单操作</div>
                    <div class="help-section-content">
                        10-30分钟执行一轮:在"待下单"界面,"1688采购" 中采购单执行:(1)最优下单,(2)代销下单
                    </div>
                </div>
                
                <div class="help-section">
                    <div class="help-section-title">手动下单操作</div>
                    <div class="help-section-content">
                        IW显示的采购单,如有报错信息,则有"下单"按钮
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 排班管理弹窗 -->
    <div id="schedule-modal-overlay" class="schedule-modal-overlay" onclick="closeScheduleModal()">
        <div class="schedule-modal" onclick="event.stopPropagation()">
            <div class="schedule-modal-header">
                <div>
                    <div class="schedule-modal-title">📅 排班管理</div>
                    <div class="schedule-modal-desc">选择日期和人员进行排班安排</div>
                </div>
                <button class="schedule-modal-close" onclick="closeScheduleModal()">&times;</button>
            </div>

            <div class="schedule-modal-content">
                <!-- 日期选择 -->
                <div class="schedule-date-selector">
                    <div class="schedule-date-group">
                        <span class="schedule-date-label">选择日期</span>
                        <input type="date" class="schedule-date-input" id="scheduleDate" onchange="loadScheduleData()">
                    </div>
                    <div class="schedule-quick-select">
                        <button class="quick-date-btn" onclick="quickSelectDate('today')">今天</button>
                        <button class="quick-date-btn" onclick="quickSelectDate('tomorrow')">明天</button>
                        <button class="quick-date-btn" onclick="quickSelectDate('dayAfter')">后天</button>
                    </div>
                </div>

                <!-- 人员列表 -->
                <div class="schedule-staff-section">
                    <div class="schedule-staff-header">
                        <span class="schedule-staff-title">人员列表</span>
                        <div class="schedule-staff-actions">
                            <button class="schedule-action-btn" onclick="toggleAllStaff(true)">全选</button>
                            <button class="schedule-action-btn" onclick="toggleAllStaff(false)">全不选</button>
                        </div>
                    </div>
                    <div class="schedule-staff-grid" id="scheduleStaffList">
                        <div class="schedule-loading">加载中...</div>
                    </div>
                </div>
            </div>

            <div class="schedule-modal-footer">
                <div class="schedule-info">
                    已选择 <strong id="scheduleSelectedCount">0</strong> 人上班
                </div>
                <div class="schedule-btn-group">
                    <button class="schedule-btn schedule-btn-secondary" onclick="resetSchedule()">重置</button>
                    <button class="schedule-btn schedule-btn-primary" id="scheduleSaveBtn" onclick="saveScheduleData()">💾 保存排班</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 付款链接弹窗 -->
    <div id="payment-link-modal" class="payment-link-modal">
        <div class="payment-link-modal-header">
            <span class="payment-link-modal-title" id="payment-link-modal-title">获取付款链接</span>
            <button class="payment-link-modal-close" onclick="closePaymentLinkModal()">&times;</button>
        </div>
        <div class="payment-link-modal-content" id="payment-link-modal-content">
        </div>
    </div>
    
    <div id="toast" class="toast"></div>
    
    <div id="request-counter" class="request-counter">
        活跃请求: <span id="request-count">0</span>
    </div>

    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <script>
        const PURCHASE_STATUS_MAP = {
            0: '等待指令',
            1: '待采购', 
            2: '采购中',
            3: '采购异常',
            4: '采购完结',
            5: '无需采购',
            6: '搁置',
            7: '等待客户反馈',
            8: '已反馈待采购'
        };

        const PURCHASE_STATUS_REVERSE_MAP = {};
        Object.keys(PURCHASE_STATUS_MAP).forEach(key => {
            PURCHASE_STATUS_REVERSE_MAP[PURCHASE_STATUS_MAP[key]] = parseInt(key);
        });

        // 排班人员列表
        const SCHEDULE_STAFF_LIST = [
            '孙凌燕',
            '姜华',
            '刘纪伟',
            '杨倩慧',
            '刘喜庆',
            '殷晴',
            '王鑫'
        ];

        function getCurrentDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function parseChineseDate(dateStr) {
            if (!dateStr) return null;
            
            const match = dateStr.match(/(\d+)月(\d+)日\s+(\d+):(\d+)/);
            if (match) {
                const currentYear = new Date().getFullYear();
                const month = parseInt(match[1]) - 1;
                const day = parseInt(match[2]);
                const hour = parseInt(match[3]);
                const minute = parseInt(match[4]);
                
                return new Date(currentYear, month, day, hour, minute);
            }
            
            return new Date(dateStr);
        }

        const CacheManager = {
            config: {
                purchaseTaskInfo: 30 * 60 * 1000,      
                purchaseInfo: 30 * 60 * 1000,          
                feedbackData: 30 * 60 * 1000,          
                orderTaskStatus: 15 * 60 * 1000,       
                purchaseOrderErrors: 15 * 60 * 1000,   
                placeOrderStatus: 15 * 60 * 1000,      
                purchaseOrderStatus: 15 * 60 * 1000,   
            },
            
            get(key) {
                try {
                    const item = localStorage.getItem(key);
                    if (!item) return null;
                    
                    const data = JSON.parse(item);
                    if (Date.now() > data.expiry) {
                        localStorage.removeItem(key);
                        return null;
                    }
                    return data.value;
                } catch (e) {
                    return null;
                }
            },
            
            set(key, value, ttl) {
                try {
                    const data = {
                        value: value,
                        expiry: Date.now() + ttl
                    };
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (e) {
                    console.error('缓存设置失败:', e);
                }
            },
            
            clearByPrefix(prefix) {
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.startsWith(prefix)) {
                        localStorage.removeItem(key);
                    }
                });
            }
        };

        class RequestQueue {
            constructor() {
                this.queue = [];
                this.running = 0;
                this.maxConcurrent = 200;
                this.minDelay = 100;
                this.maxDelay = 300;
                this.retryAttempts = 3;
                this.retryDelay = 2000;
            }
            
            async randomDelay() {
                const delay = Math.random() * (this.maxDelay - this.minDelay) + this.minDelay;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
            
            async executeWithRetry(requestFn, attempt = 0) {
                try {
                    const result = await requestFn();
                    return result;
                } catch (error) {
                    if (error.status === 429 && attempt < this.retryAttempts) {
                        console.warn(`遇到429错误,${this.retryDelay/1000}秒后重试... (第${attempt + 1}次)`);
                        await new Promise(resolve => setTimeout(resolve, this.retryDelay * (attempt + 1)));
                        return this.executeWithRetry(requestFn, attempt + 1);
                    }
                    throw error;
                }
            }
            
            async add(requestFn) {
                return new Promise((resolve, reject) => {
                    this.queue.push({ requestFn, resolve, reject });
                    this.process();
                });
            }
            
            async process() {
                if (this.running >= this.maxConcurrent || this.queue.length === 0) {
                    return;
                }
                
                this.running++;
                const { requestFn, resolve, reject } = this.queue.shift();
                
                try {
                    await this.randomDelay();
                    const result = await this.executeWithRetry(requestFn);
                    resolve(result);
                } catch (error) {
                    reject(error);
                } finally {
                    this.running--;
                    this.process();
                }
            }
        }

        const globalRequestQueue = new RequestQueue();

        let activeRequests = 0;
        const originalFetch = window.fetch;

        window.fetch = function(...args) {
            activeRequests++;
            updateRequestCounter();
            
            return originalFetch.apply(this, args)
                .then(response => {
                    if (response.status === 429) {
                        const error = new Error('Too Many Requests');
                        error.status = 429;
                        throw error;
                    }
                    return response;
                })
                .finally(() => {
                    activeRequests--;
                    updateRequestCounter();
                });
        };

        function updateRequestCounter() {
            const counter = document.getElementById('request-counter');
            const count = document.getElementById('request-count');
            
            if (count) {
                count.textContent = activeRequests;
            }
            
            if (counter) {
                if (activeRequests > 0) {
                    counter.classList.add('show');
                    if (activeRequests > 10) {
                        counter.classList.add('warning');
                    } else {
                        counter.classList.remove('warning');
                    }
                } else {
                    counter.classList.remove('show');
                }
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        function parseJsonArray(jsonStr) {
            if (!jsonStr) return [];
            
            try {
                if (Array.isArray(jsonStr)) {
                    return jsonStr;
                }
                
                if (typeof jsonStr === 'string') {
                    let processedStr = jsonStr;
                    if (processedStr.includes("'")) {
                        processedStr = processedStr.replace(/'/g, '"');
                    }
                    return JSON.parse(processedStr);
                }
                
                return [];
            } catch (e) {
                console.error('解析JSON数组错误:', e, 'Original string:', jsonStr);
                return [];
            }
        }
        
        let userId = null;
        let hasSchedulePermission = false; // 新增：排班权限标记，只有用户名为admin时为true
        const apiBaseUrl = 'http://47.104.72.198:3000';
        const loginApiUrl = 'http://47.95.157.46:8520/api';  // 登录API保持旧服务器
        const paymentApiUrl = 'http://59.110.116.113:8000/api/get_pay_url';
        const loginKey = 'purchaseManagementLogin';
        
        let currentTaskId = null;
        let currentTaskData = null;
        let tasksData = {};
        let allTasksData = [];
        let currentCategoryFilter = 'running';
        let tasksWithErrors = new Set();
        let taskRefreshTimer = null;
        
        const taskOrdersData = {};
        const taskPurchaseData = {};
        const taskOrderStatusData = {};
        const taskPurchaseErrorsData = {};
        const taskPlaceOrderStatusData = {};
        const taskPurchaseOrderStatusData = {};
        const taskCollapsedState = {};
        
        const loginPage = document.getElementById('login-page');
        const taskPage = document.getElementById('task-page');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userBar = document.getElementById('user-bar');
        const usernameDisplay = document.getElementById('username-display');
        const taskList = document.getElementById('task-list');
        const toast = document.getElementById('toast');
        const sidebar = document.getElementById('sidebar');
        const sidebarContent = document.getElementById('sidebar-content');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        const productDetailPopup = document.getElementById('product-detail-popup');
        const popupOverlay = document.getElementById('popup-overlay');
        const popupCloseBtn = document.getElementById('popup-close-btn');
        
        document.addEventListener('DOMContentLoaded', init);
        
        function init() {
            console.log('初始化应用...');
            checkLoginStatus();
            addEventListeners();
        }
        

        function startTaskRefreshTimer() {
            if (taskRefreshTimer) {
                clearInterval(taskRefreshTimer);
            }
            
            taskRefreshTimer = setInterval(() => {
                console.log('定时刷新任务列表...');
                refreshTaskList();
            }, 5 * 60 * 1000);
            
            console.log('任务定时刷新已启动(每5分钟)');
        }

        function stopTaskRefreshTimer() {
            if (taskRefreshTimer) {
                clearInterval(taskRefreshTimer);
                taskRefreshTimer = null;
                console.log('任务定时刷新已停止');
            }
        }
        

        async function refreshTaskList() {
            if (!userId) return;
            
            try {
                const savedCategoryFilter = currentCategoryFilter;
                const savedTaskId = currentTaskId;
                
                const response = await fetch(`${apiBaseUrl}/get_purchase_iw_task`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ conductor: String(userId) })
                });

                const result = await response.json();
                console.log('刷新任务列表结果:', result);
                
                if (result.success && result.data) {
                    tasksData = {};
                    allTasksData = result.data;
                    result.data.forEach(task => {
                        tasksData[task.id] = task;
                    });
                    
                    // 注释掉：不再预加载所有任务的错误信息，只在点击任务时加载
                    // await preloadTaskErrors(result.data);
                    
                    updateTaskStatistics(result.data);
                    
                    const filteredTasks = getFilteredTasksByCategory(result.data, savedCategoryFilter);
                    renderSidebarTasks(filteredTasks);
                    
                    document.querySelectorAll('.task-stat-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    const activeItem = document.querySelector(`.task-stat-item.${savedCategoryFilter}`);
                    if (activeItem) {
                        activeItem.classList.add('active');
                    }
                    
                    if (savedTaskId && tasksData[savedTaskId]) {
                        document.querySelectorAll('.sidebar-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        const targetItem = document.querySelector(`[data-task-id="${savedTaskId}"]`);
                        if (targetItem) {
                            targetItem.classList.add('active');
                        }
                    }
                    
                    console.log('任务列表刷新成功，保持了右侧详情页面');
                }
            } catch (error) {
                console.error('刷新任务列表错误:', error);
            }
        }

        function checkLoginStatus() {
            const loginData = localStorage.getItem(loginKey);
            if (loginData) {
                try {
                    const data = JSON.parse(loginData);
                    if (data.expireTime > Date.now()) {
                        userId = data.userId;
                        // 检查排班权限：只有用户名为admin时才有权限
                        hasSchedulePermission = (data.username === 'admin');
                        console.log(`从本地存储恢复登录 - 用户名: ${data.username}, 用户ID: ${userId}, 排班权限: ${hasSchedulePermission}`);
                        
                        switchToTaskPage(data.username);
                        // 更新排班按钮的显示状态
                        updateScheduleButtonVisibility();
                        fetchTasks();
                        startTaskRefreshTimer();
                        return;
                    }
                } catch (error) {
                    console.error('解析登录数据错误:', error);
                }
                
                localStorage.removeItem(loginKey);
            }
            
            switchToLoginPage();
        }
        
        function addEventListeners() {
            loginBtn.addEventListener('click', handleLogin);
            logoutBtn.addEventListener('click', handleLogout);
            
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });
            
            popupCloseBtn.addEventListener('click', closeProductDetailPopup);
            popupOverlay.addEventListener('click', closeProductDetailPopup);
            
            productDetailPopup.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            document.addEventListener('click', (e) => {
                const dropdowns = document.querySelectorAll('.purchase-dropdown, .check-dropdown, .purchase-status-options, .payment-link-dropdown');
                dropdowns.forEach(dropdown => {
                    if (!dropdown.contains(e.target) && !dropdown.previousElementSibling.contains(e.target)) {
                        dropdown.classList.remove('show');
                    }
                });
            });
        }
        
        function switchToLoginPage() {
            loginPage.style.display = 'flex';
            taskPage.style.display = 'none';
            userBar.style.display = 'none';
            sidebar.style.display = 'none';
        }
        
        function switchToTaskPage(username) {
            loginPage.style.display = 'none';
            taskPage.style.display = 'block';
            userBar.style.display = 'flex';
            sidebar.style.display = 'flex';
            usernameDisplay.textContent = username || '用户';
        }
        
        
        
        function showHelpPopup() {
            const helpPopupOverlay = document.getElementById('help-popup-overlay');
            helpPopupOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function hideHelpPopup() {
            const helpPopupOverlay = document.getElementById('help-popup-overlay');
            helpPopupOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        function showLoadingOverlay() {
            loadingOverlay.classList.add('active');
        }

        function hideLoadingOverlay() {
            loadingOverlay.classList.remove('active');
        }

        // ==================== 排班管理功能 ====================
        
        // 打开排班弹窗
        function openScheduleModal() {
            // 权限检查：只有用户名为admin的用户才能打开排班弹窗
            if (!hasSchedulePermission) {
                showToast('您没有排班管理权限', 'error');
                console.log('权限不足：用户名不是admin，无法访问排班功能');
                return;
            }
            
            const modal = document.getElementById('schedule-modal-overlay');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // 默认显示明天
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('scheduleDate').value = formatDate(tomorrow);
            
            // 渲染人员列表
            renderScheduleStaffList();
            
            // 加载排班数据
            loadScheduleData();
        }

        // 关闭排班弹窗
        function closeScheduleModal() {
            const modal = document.getElementById('schedule-modal-overlay');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // 渲染人员列表
        function renderScheduleStaffList() {
            const staffList = document.getElementById('scheduleStaffList');
            
            let html = '';
            SCHEDULE_STAFF_LIST.forEach((staffName) => {
                html += `
                    <div class="schedule-staff-checkbox">
                        <input type="checkbox" id="schedule-staff-${staffName}" 
                               data-staff-name="${staffName}"
                               onchange="updateScheduleCount()">
                        <label for="schedule-staff-${staffName}">${staffName}</label>
                    </div>
                `;
            });
            
            staffList.innerHTML = html;
            updateScheduleCount();
        }

        // 快捷选择日期
        function quickSelectDate(type) {
            const date = new Date();
            switch(type) {
                case 'today':
                    break;
                case 'tomorrow':
                    date.setDate(date.getDate() + 1);
                    break;
                case 'dayAfter':
                    date.setDate(date.getDate() + 2);
                    break;
                default:
                    return;
            }
            
            document.getElementById('scheduleDate').value = formatDate(date);
            loadScheduleData();
        }

        // 全选/全不选
        function toggleAllStaff(checked) {
            const checkboxes = document.querySelectorAll('#scheduleStaffList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = checked);
            updateScheduleCount();
        }

        // 更新统计
        function updateScheduleCount() {
            const checkboxes = document.querySelectorAll('#scheduleStaffList input[type="checkbox"]');
            const count = Array.from(checkboxes).filter(cb => cb.checked).length;
            document.getElementById('scheduleSelectedCount').textContent = count;
        }

        // 加载排班数据
        async function loadScheduleData() {
            const selectedDate = document.getElementById('scheduleDate').value;
            
            if (!selectedDate) {
                showToast('请选择日期', 'error');
                return;
            }

            try {
                const response = await fetch(`${apiBaseUrl}/get_staff_name`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        recordDate: selectedDate
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('排班数据加载结果:', result);
                
                if (result.success && result.data) {
                    // 获取排班的人员姓名列表
                    const scheduledNames = result.data.map(item => item.staff_name);
                    console.log('已排班人员:', scheduledNames);
                    
                    // 先取消所有勾选
                    const allCheckboxes = document.querySelectorAll('#scheduleStaffList input[type="checkbox"]');
                    allCheckboxes.forEach(cb => cb.checked = false);
                    
                    // 根据返回的姓名设置勾选状态
                    scheduledNames.forEach(staffName => {
                        const checkbox = document.getElementById(`schedule-staff-${staffName}`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                    
                    updateScheduleCount();
                    console.log(`${selectedDate} 排班数据加载成功`);
                } else {
                    // 如果没有排班数据，默认全不选
                    const allCheckboxes = document.querySelectorAll('#scheduleStaffList input[type="checkbox"]');
                    allCheckboxes.forEach(cb => cb.checked = false);
                    updateScheduleCount();
                    console.log(`${selectedDate} 暂无排班数据`);
                }
            } catch (error) {
                console.error('加载排班数据失败:', error);
                showToast('加载排班数据失败: ' + error.message, 'error');
            }
        }

        // 重置排班（全选）
        function resetSchedule() {
            toggleAllStaff(true);
            showToast('已重置为全员上班', 'success');
        }

        // 保存排班数据
        async function saveScheduleData() {
            const selectedDate = document.getElementById('scheduleDate').value;
            
            if (!selectedDate) {
                showToast('请选择日期', 'error');
                return;
            }

            // 收集所有选中的人员姓名
            const selectedStaffNames = [];
            const allCheckboxes = document.querySelectorAll('#scheduleStaffList input[type="checkbox"]:checked');
            
            allCheckboxes.forEach(checkbox => {
                const staffName = checkbox.getAttribute('data-staff-name');
                if (staffName) {
                    selectedStaffNames.push(staffName);
                }
            });

            if (selectedStaffNames.length === 0) {
                showToast('请至少选择一名人员', 'error');
                return;
            }

            // 禁用保存按钮，防止重复提交
            const saveBtn = document.getElementById('scheduleSaveBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = '保存中...';

            try {
                const response = await fetch(`${apiBaseUrl}/syncStaffRecords`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        recordDate: selectedDate,
                        staffNameList: selectedStaffNames
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('保存排班结果:', result);
                
                if (result.success) {
                    showToast(`${selectedDate} 排班保存成功！共 ${selectedStaffNames.length} 人`, 'success');
                    console.log('保存成功:', {
                        date: selectedDate,
                        staff_names: selectedStaffNames,
                        count: selectedStaffNames.length
                    });
                } else {
                    throw new Error(result.msg || '保存失败');
                }
            } catch (error) {
                console.error('保存失败:', error);
                showToast('保存失败: ' + error.message, 'error');
            } finally {
                // 恢复保存按钮
                saveBtn.disabled = false;
                saveBtn.textContent = '💾 保存排班';
            }
        }

        // ==================== 排班管理功能结束 ====================
        
        /**
         * 更新排班管理按钮的显示状态
         * 只有当 hasSchedulePermission = true (即用户名为 admin) 时才显示
         */
        function updateScheduleButtonVisibility() {
            const scheduleBtn = document.getElementById('schedule-manage-btn');
            if (scheduleBtn) {
                if (hasSchedulePermission) {
                    scheduleBtn.classList.add('show');
                    console.log('排班按钮已显示 (用户名=admin)');
                } else {
                    scheduleBtn.classList.remove('show');
                    console.log('排班按钮已隐藏 (用户名≠admin)');
                }
            }
        }
        
        async function handleLogin() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!username || !password) {
                showToast('请输入用户名和密码', 'error');
                return;
            }
            
            try {
                const formData = new URLSearchParams();
                formData.append('acct', username);
                formData.append('password', password);
                
                const response = await fetch(`${loginApiUrl}/csdl`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: formData
                });
                
                const result = await response.json();
                console.log('登录结果:', result);
                
                if (result.success && 
                    result.data?.data?.code === 200 && 
                    result.data?.data?.message === 'ok' && 
                    result.data?.data?.data?.id) {
                    
                    // 获取用户ID
                    userId = result.data.data.data.id;
                    
                    // 检查排班权限：只有用户名为admin时才有权限
                    hasSchedulePermission = (username === 'admin');
                    console.log(`用户名: ${username}, 用户ID: ${userId}, 排班权限: ${hasSchedulePermission}`);
                    
                    // 保存登录信息到本地存储
                    const expireTime = Date.now() + 7 * 24 * 60 * 60 * 1000;
                    localStorage.setItem(loginKey, JSON.stringify({
                        userId,
                        username,
                        expireTime,
                        hasSchedulePermission // 保存权限信息
                    }));
                    
                    switchToTaskPage(username);
                    // 更新排班按钮的显示状态
                    updateScheduleButtonVisibility();
                    fetchTasks();
                    startTaskRefreshTimer();
                    showToast('登录成功', 'success');
                } else {
                    const errorMessage = result.data?.data?.message || '登录失败';
                    showToast('登录失败:' + errorMessage, 'error');
                }
            } catch (error) {
                console.error('登录错误:', error);
                showToast('网络错误,请重试', 'error');
            }
        }
        
        function handleLogout() {
            stopTaskRefreshTimer();
            localStorage.removeItem(loginKey);
            CacheManager.clearByPrefix('purchaseTaskInfo_');
            CacheManager.clearByPrefix('purchaseInfo_');
            CacheManager.clearByPrefix('feedbackData_');
            CacheManager.clearByPrefix('orderTaskStatus_');
            CacheManager.clearByPrefix('purchaseOrderErrors_');
            CacheManager.clearByPrefix('placeOrderStatus_');
            CacheManager.clearByPrefix('purchaseOrderStatus_');
            
            userId = null;
            hasSchedulePermission = false; // 重置排班权限
            currentTaskId = null;
            currentTaskData = null;
            tasksData = {};
            allTasksData = [];
            currentCategoryFilter = 'running';
            tasksWithErrors.clear();
            updateScheduleButtonVisibility(); // 更新按钮显示状态
            switchToLoginPage();
            taskList.innerHTML = '';
            sidebarContent.innerHTML = '';
            showToast('已退出登录', 'success');
        }
        
        async function fetchTasks() {
            if (!userId) return;

            sidebarContent.innerHTML = '<div class="loading">正在加载任务...</div>';

            try {
                const response = await fetch(`${apiBaseUrl}/get_purchase_iw_task`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ conductor: String(userId) })
                });

                const result = await response.json();
                console.log('任务列表结果:', result);
                
                if (result.success && result.data) {
                    tasksData = {};
                    allTasksData = result.data;
                    result.data.forEach(task => {
                        tasksData[task.id] = task;
                    });
                    
                    // 注释掉：不再预加载所有任务的错误信息，只在点击任务时加载
                    // await preloadTaskErrors(result.data);
                    
                    renderTasks(result.data);
                } else {
                    sidebarContent.innerHTML = '<div class="error">获取任务列表失败:' + (result.msg || '未知错误') + '</div>';
                }
            } catch (error) {
                console.error('获取任务列表错误:', error);
                sidebarContent.innerHTML = '<div class="error">获取任务列表出错,请重试</div>';
            }
        }

        async function preloadTaskErrors(tasks) {
            tasksWithErrors.clear();
            
            try {
                const promises = tasks.map(async (task) => {
                    try {
                        const purchaseInfo = await fetchPurchaseInfo(task.id);
                        if (purchaseInfo.purchases && purchaseInfo.purchases.length > 0) {
                            const purchaseNumbers = purchaseInfo.purchases.map(p => p.dxm_po_number).filter(num => num);
                            if (purchaseNumbers.length > 0) {
                                const purchaseErrors = await fetchPurchaseOrderErrors(purchaseNumbers);
                                
                                const hasAnyError = Object.values(purchaseErrors).some(errorInfo => errorInfo.hasError);
                                if (hasAnyError) {
                                    tasksWithErrors.add(task.id);
                                }
                            }
                        }
                    } catch (error) {
                        console.error(`预加载任务${task.id}错误信息失败:`, error);
                    }
                });
                
                await Promise.all(promises);
                console.log('预加载完成，有错误的任务:', Array.from(tasksWithErrors));
            } catch (error) {
                console.error('预加载任务错误信息失败:', error);
            }
        }
        
        async function renderTasks(tasks) {
            if (!tasks.length) {
                sidebarContent.innerHTML = '<div class="no-data">暂无任务</div>';
                taskList.innerHTML = '<div class="no-data">暂无任务</div>';
                return;
            }
            
            updateTaskStatistics(tasks);
            
            const categories = ['running', 'waiting', 'completed-first', 'completed-second', 'finished', 'error'];
            let firstCategoryWithTasks = null;
            for (const cat of categories) {
                const filteredTasks = getFilteredTasksByCategory(tasks, cat);
                if (filteredTasks.length > 0) {
                    firstCategoryWithTasks = cat;
                    break;
                }
            }
            
            if (firstCategoryWithTasks) {
                selectCategory(firstCategoryWithTasks);
            } else {
                sidebarContent.innerHTML = '<div class="no-data">暂无任务</div>';
            }
            
            taskList.innerHTML = '<div class="loading">👈 请从左侧选择任务查看详情</div>';
        }

        function updateTaskStatistics(tasks) {
            const stats = {
                running: 0,
                waiting: 0,
                'completed-first': 0,
                'completed-second': 0,
                finished: 0,
                error: 0
            };

            tasks.forEach(task => {
                const status = task.iw_status || '';
                const taskId = task.id;
                
                if (status.includes('任务完结')) {
                    stats.finished++;
                } else if (status.includes('运行中')) {
                    stats.running++;
                } else if (status.includes('等待采购')) {
                    stats.waiting++;
                } else if (status.includes('运行结束')) {
                    if (status.includes('首次运行-运行结束')) {
                        stats['completed-first']++;
                    } else if (status.includes('二次运行-运行结束')) {
                        stats['completed-second']++;
                    }
                } else if (status.includes('错误') || status.includes('异常') || tasksWithErrors.has(taskId)) {
                    stats.error++;
                }
            });

            document.getElementById('runningCount').textContent = stats.running;
            document.getElementById('waitingCount').textContent = stats.waiting;
            document.getElementById('completedFirstCount').textContent = stats['completed-first'];
            document.getElementById('completedSecondCount').textContent = stats['completed-second'];
            document.getElementById('finishedCount').textContent = stats.finished;
            document.getElementById('errorCount').textContent = stats.error;
        }

        function getFilteredTasksByCategory(tasks, category) {
            return tasks.filter(task => {
                const status = task.iw_status || '';
                const taskId = task.id;
                
                if (category === 'finished') {
                    return status.includes('任务完结');
                } else if (category === 'running') {
                    return status.includes('运行中');
                } else if (category === 'waiting') {
                    return status.includes('等待采购');
                } else if (category === 'completed-first') {
                    return status.includes('首次运行-运行结束');
                } else if (category === 'completed-second') {
                    return status.includes('二次运行-运行结束');
                } else if (category === 'error') {
                    return status.includes('错误') || status.includes('异常') || tasksWithErrors.has(taskId);
                }
                return false;
            });
        }

        function selectCategory(categoryKey) {
            currentCategoryFilter = categoryKey;
            
            document.querySelectorAll('.task-stat-item').forEach(item => {
                item.classList.remove('active');
            });
            const activeItem = document.querySelector(`.task-stat-item.${categoryKey}`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
            
            document.getElementById('invoiceSearchInput').value = '';
            
            const filteredTasks = getFilteredTasksByCategory(allTasksData, categoryKey);
            renderSidebarTasks(filteredTasks);
        }

        function filterByInvoiceCode() {
            const searchText = document.getElementById('invoiceSearchInput').value.trim().toLowerCase();
            
            if (!searchText) {
                const categoryTasks = getFilteredTasksByCategory(allTasksData, currentCategoryFilter);
                renderSidebarTasks(categoryTasks);
                return;
            }
            
            const searchResults = allTasksData.filter(task => {
                const invoiceCode = (task.last_invoice_code || '').toLowerCase();
                return invoiceCode.includes(searchText);
            });
            
            renderSidebarTasks(searchResults);
        }

        function renderSidebarTasks(tasks) {
            if (!tasks || tasks.length === 0) {
                sidebarContent.innerHTML = '<div class="no-data">暂无任务</div>';
                return;
            }
            
            let html = '';
            tasks.forEach(task => {
                const parsedDate = parseChineseDate(task.queue_entry_time);
                const time = parsedDate ? parsedDate.toLocaleString() : task.queue_entry_time;
                
                const isActive = currentTaskId === task.id ? 'active' : '';
                html += `
                    <div class="sidebar-item ${isActive}" data-task-id="${task.id}">
                        <span class="sidebar-item-title">${task.last_invoice_code || 'NO.' + task.id}</span>
                        <div class="sidebar-item-info">
                            <span class="sidebar-item-stat">状态: ${task.iw_status}</span>
                            <span class="sidebar-item-conductor">时间: ${time}</span>
                        </div>
                    </div>
                `;
            });
            
            sidebarContent.innerHTML = html;
            
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.addEventListener('click', () => {
                    const taskId = item.getAttribute('data-task-id');
                    selectTask(taskId);
                });
            });
        }
        
        async function selectTask(invoiceId) {
            showLoadingOverlay();

            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            const targetItem = document.querySelector(`[data-task-id="${invoiceId}"]`);
            if (targetItem) {
                targetItem.classList.add('active');
            }
            
            currentTaskId = invoiceId;
            
            taskList.innerHTML = '<div class="loading">正在加载任务详情...</div>';
            
            try {
                await loadTaskDetail(invoiceId);
            } catch (error) {
                console.error('加载任务详情错误:', error);
                taskList.innerHTML = '<div class="error">加载任务详情失败,请重试</div>';
            } finally {
                hideLoadingOverlay();
            }
        }
        
        async function loadTaskDetail(invoiceId) {
            try {
                console.log('开始加载任务详情...');
                
                const taskInfo = await fetchPurchaseTaskInfo(invoiceId);
                const purchaseInfo = await fetchPurchaseInfo(invoiceId);
                const feedbackData = await fetchFeedbackData(invoiceId);
                const purchaseOrderStatus = await fetchPurchaseOrderStatus(invoiceId);
                
                taskOrdersData[invoiceId] = taskInfo.orders;
                taskPurchaseData[invoiceId] = purchaseInfo.purchases;
                taskPurchaseOrderStatusData[invoiceId] = purchaseOrderStatus;
                
                console.log('基础信息加载完成');
                
                const orderIds = taskInfo.orders.map(order => order.order_id).filter(id => id);
                if (orderIds.length > 0) {
                    const orderStatuses = await fetchOrderTaskStatus(orderIds);
                    taskOrderStatusData[invoiceId] = orderStatuses;
                }
                
                console.log('订单状态加载完成');
                
                const purchaseNumbers = purchaseInfo.purchases.map(p => p.dxm_po_number).filter(num => num);
                if (purchaseNumbers.length > 0) {
                    console.log(`开始加载${purchaseNumbers.length}个采购单信息...`);
                    
                    const purchaseErrors = await fetchPurchaseOrderErrors(purchaseNumbers);
                    taskPurchaseErrorsData[invoiceId] = purchaseErrors;
                    
                    const placeOrderStatuses = await fetchPlaceOrderStatus(purchaseNumbers);
                    taskPlaceOrderStatusData[invoiceId] = placeOrderStatuses;
                    
                    console.log('采购单信息加载完成');
                }
                
                renderTaskDetail(invoiceId, feedbackData.feedbacks);
                
            } catch (error) {
                console.error('获取任务详情错误:', error);
                taskList.innerHTML = '<div class="error">网络错误,请重试</div>';
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function renderTaskDetail(invoiceId, feedbacks) {
            const task = tasksData[invoiceId];
            if (!task) {
                taskList.innerHTML = '<div class="error">任务数据不存在</div>';
                return;
            }
            
            const status = task.iw_status || '未知状态';
            const isCompleted = status.includes('已完成') || status.includes('完成');
            const isFinished = status.includes('运行结束') || status.includes('任务完结');
            const isRunning = status.includes('运行中');
            
            let statusClass = 'status-running';
            let statusIcon = 'https://seal-img.nos-jd.163yun.com/obj/w5rCgMKVw6DCmGzCmsK-/60049032397/7954/b733/5186/371a3ebccfc7ae3958fd33be38c323c9.png';
            
            if (isFinished) {
                statusClass = 'status-finished';
                statusIcon = 'https://seal-img.nos-jd.163yun.com/obj/w5rCgMKVw6DCmGzCmsK-/60049070483/1017/299d/3dd9/ad36449d48f83dcb778ff89b429a58f2.png';
            } else if (isCompleted) {
                statusClass = 'status-completed';
                statusIcon = 'https://seal-img.nos-jd.163yun.com/obj/w5rCgMKVw6DCmGzCmsK-/60049070483/1017/299d/3dd9/ad36449d48f83dcb778ff89b429a58f2.png';
            }
            
            const orderCount = taskOrdersData[invoiceId]?.length || 0;
            const completedCount = calculateCompletedOrdersCount(taskOrdersData[invoiceId] || []);
            
            let html = `
                <div class="task-block" data-invoice-id="${invoiceId}">
                    <div class="task-header">
                        <div class="task-header-left">
                            <div class="task-number">NO.${task.id}</div>
                            <div class="${statusClass}">
                                <img src="${statusIcon}">
                                <span>${status}</span>
                            </div>
                            <button class="complete-task-btn" onclick="handleCompleteTask('${task.id}')">采购完结</button>
                            <div class="intention-code">采购单编号: ${task.last_invoice_code || '无'}</div>
                            <div class="task-details-info" id="task-details-${task.id}">
                                <div class="task-detail-item">
                                    <span class="task-detail-label">订单数量:</span>
                                    <span class="task-detail-value">${orderCount}</span>
                                </div>
                                <div class="task-detail-item">
                                    <span class="task-detail-label">完结订单数量:</span>
                                    <span class="task-detail-value">${completedCount}</span>
                                </div>
                                <div class="task-detail-item">
                                    <span class="task-detail-label">处理人:</span>
                                    <span class="task-detail-value">${task.conductor_name || '未知'}</span>
                                </div>
                                <div class="task-detail-item">
                                    <span class="task-detail-label">采购单状态:</span>
                                    <div class="purchase-status-dropdown">
                                        <button class="purchase-status-button" id="purchase-status-btn-${task.id}" onclick="togglePurchaseStatusDropdown('${task.id}')">
                                            ${PURCHASE_STATUS_MAP[taskPurchaseOrderStatusData[invoiceId]] || '未知状态'}
                                        </button>
                                        <div class="purchase-status-options" id="purchase-status-options-${task.id}">
                                            ${Object.entries(PURCHASE_STATUS_MAP).map(([key, value]) => 
                                                `<div class="purchase-status-option" onclick="changePurchaseStatus('${task.id}', ${key})">${value}</div>`
                                            ).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="task-header-right">
                            <div class="check-orders-button" ${isRunning ? '' : `onclick="toggleCheckDropdown('${task.id}')"`}>
                                <div class="check-orders-button-inner ${isRunning ? 'disabled' : ''}">提交配对任务</div>
                                ${isRunning ? '' : `<div class="check-dropdown" id="check-dropdown-${task.id}">
                                    <div class="check-dropdown-item" onclick="submitSelectedOrdersCheck('${task.id}')">配对勾选订单</div>
                                    <div class="check-dropdown-item" onclick="submitAllOrdersCheck('${task.id}')">配对全部订单</div>
                                </div>`}
                            </div>
                            <div class="purchase-wait-button" onclick="togglePurchaseDropdown('${task.id}')">
                                <div class="purchase-wait-button-inner">等待采购</div>
                                <div class="purchase-dropdown" id="purchase-dropdown-${task.id}">
                                    <div class="purchase-dropdown-item" onclick="submitSelectedOrders('${task.id}')">等待采购-提交勾选订单</div>
                                    <div class="purchase-dropdown-item" onclick="submitAllOrders('${task.id}')">等待采购-提交全部订单</div>
                                </div>
                            </div>
                            <div class="toggle-orders-button" onclick="toggleCollapsedOrders('${task.id}')">
                                <div class="toggle-orders-button-inner" id="toggle-text-${task.id}">折叠订单</div>
                            </div>
                            <div class="refresh-button" onclick="refreshTask('${task.id}')">
                                <div class="refresh-button-inner">刷新此任务</div>
                            </div>
                            <div class="task-time">加入时间: ${task.queue_entry_time || '未知'}</div>
                        </div>
                    </div>
                    <div class="task-content">
            `;
            
            html += renderFeedbackSection(feedbacks, invoiceId);
            
            const orders = taskOrdersData[invoiceId] || [];
            if (orders.length > 0) {
                html += renderOrdersSection(orders, invoiceId);
            }
            
            const purchaseData = taskPurchaseData[invoiceId] || [];
            if (purchaseData.length > 0) {
                html += renderPurchaseSection(purchaseData, invoiceId);
            }
            
            html += `
                    </div>
                </div>
            `;
            
            taskList.innerHTML = html;
        }

        async function handleCompleteTask(taskId) {
            if (!confirm('确定要将此任务标记为"采购完结"吗?')) {
                return;
            }

            const button = event.target;
            button.disabled = true;
            button.textContent = '处理中...';

            try {
                const response = await fetch(`${apiBaseUrl}/update_iw_status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: taskId,
                        iw_status: "任务完结"
                    })
                });

                const result = await response.json();
                console.log('采购完结结果:', result);

                if (result.success) {
                    showToast('任务已标记为采购完结', 'success');
                    
                    setTimeout(() => {
                        fetchTasks();
                    }, 2000);
                } else {
                    showToast('操作失败:' + (result.msg || '未知错误'), 'error');
                    button.disabled = false;
                    button.textContent = '采购完结';
                }
            } catch (error) {
                console.error('采购完结错误:', error);
                showToast('操作出错,请重试', 'error');
                button.disabled = false;
                button.textContent = '采购完结';
            }
        }
        
        async function fetchPurchaseTaskInfo(invoiceId) {
            const cacheKey = `purchaseTaskInfo_${invoiceId}`;
            const cached = CacheManager.get(cacheKey);
            if (cached) return cached;
            
            return globalRequestQueue.add(async () => {
                try {
                    const response = await fetch(`${apiBaseUrl}/get_task_purchase_iw`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ invoice_id: String(invoiceId) })
                    });

                    const result = await response.json();
                    console.log('采购任务信息结果:', result);
                    
                    if (result.success && result.data && result.data.length > 0) {
                        const taskInfo = {
                            orders: result.data
                        };
                        
                        CacheManager.set(cacheKey, taskInfo, CacheManager.config.purchaseTaskInfo);
                        
                        return taskInfo;
                    } else {
                        return {
                            orders: []
                        };
                    }
                } catch (error) {
                    console.error('获取采购任务信息错误:', error);
                    return {
                        orders: []
                    };
                }
            });
        }
        
        async function fetchPurchaseInfo(invoiceId) {
            const cacheKey = `purchaseInfo_${invoiceId}`;
            const cached = CacheManager.get(cacheKey);
            if (cached) return cached;
            
            return globalRequestQueue.add(async () => {
                try {
                    const response = await fetch(`${apiBaseUrl}/get_purchase_info`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ id: String(invoiceId), searchDate: getCurrentDate() })
                    });

                    const result = await response.json();
                    console.log('采购单信息结果:', result);
                    
                    if (result.success && result.data) {
                        const purchaseInfo = {
                            purchases: result.data
                        };
                        
                        CacheManager.set(cacheKey, purchaseInfo, CacheManager.config.purchaseInfo);
                        
                        return purchaseInfo;
                    } else {
                        return {
                            purchases: []
                        };
                    }
                } catch (error) {
                    console.error('获取采购单信息错误:', error);
                    return {
                        purchases: []
                    };
                }
            });
        }
        
        async function fetchFeedbackData(invoiceId) {
            const cacheKey = `feedbackData_${invoiceId}`;
            const cached = CacheManager.get(cacheKey);
            if (cached) return cached;
            
            return globalRequestQueue.add(async () => {
                const response = await fetch(`${apiBaseUrl}/get_last_invoices_feedbacks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: String(invoiceId) })
                });

                const result = await response.json();
                console.log('反馈信息结果:', result);
                
                if (result.success && result.data) {
                    const data = {
                        feedbacks: result.data
                    };
                    
                    CacheManager.set(cacheKey, data, CacheManager.config.feedbackData);
                    
                    return data;
                } else {
                    const data = {
                        feedbacks: []
                    };
                    
                    CacheManager.set(cacheKey, data, CacheManager.config.feedbackData);
                    
                    return data;
                }
            });
        }

        async function fetchOrderTaskStatus(orderIdList) {
            if (!orderIdList || orderIdList.length === 0) return {};
            
            const cacheKey = `orderTaskStatus_${orderIdList.sort().join(',')}`;
            const cached = CacheManager.get(cacheKey);
            if (cached) return cached;
            
            return globalRequestQueue.add(async () => {
                try {
                    const response = await fetch(`${apiBaseUrl}/get_order_task`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            orderIdList: orderIdList
                        })
                    });
                    
                    const result = await response.json();
                    console.log('订单采购状态结果:', result);
                    
                    if (result.success && result.data && result.data.length > 0) {
                        const resultDict = result.data[0].result_dict;
                        let orderStatusMap = {};
                        
                        if (resultDict) {
                            try {
                                orderStatusMap = JSON.parse(resultDict);
                            } catch (e) {
                                console.error('解析订单状态字典错误:', e);
                                orderStatusMap = {};
                            }
                        }
                        
                        CacheManager.set(cacheKey, orderStatusMap, CacheManager.config.orderTaskStatus);
                        return orderStatusMap;
                    } else {
                        return {};
                    }
                } catch (error) {
                    console.error('获取订单采购状态错误:', error);
                    return {};
                }
            });
        }

        async function fetchPurchaseOrderErrors(purchaseNumberList) {
            if (!purchaseNumberList || purchaseNumberList.length === 0) return {};
            
            const cacheKey = `purchaseOrderErrors_${purchaseNumberList.sort().join(',')}`;
            const cached = CacheManager.get(cacheKey);
            if (cached) return cached;
            
            return globalRequestQueue.add(async () => {
                try {
                    const errorResults = {};
                    
                    const promises = purchaseNumberList.map(async (purchaseNumber) => {
                        try {
                            const response = await fetch(`${apiBaseUrl}/get_purchase_order_errors`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    purchasingNum: purchaseNumber
                                })
                            });
                            
                            const result = await response.json();
                            console.log(`采购单${purchaseNumber}错误信息结果:`, result);
                            
                            if (result.success && result.data && result.data.length > 0) {
                                const errorInfo = result.data[0];
                                errorResults[purchaseNumber] = {
                                    hasError: errorInfo.result !== null && errorInfo.result !== undefined && errorInfo.result !== '',
                                    errorMessage: errorInfo.result || null
                                };
                            } else {
                                errorResults[purchaseNumber] = {
                                    hasError: false,
                                    errorMessage: null
                                };
                            }
                        } catch (error) {
                            console.error(`获取采购单${purchaseNumber}错误信息失败:`, error);
                            errorResults[purchaseNumber] = {
                                hasError: false,
                                errorMessage: null
                            };
                        }
                    });
                    
                    await Promise.all(promises);
                    
                    CacheManager.set(cacheKey, errorResults, CacheManager.config.purchaseOrderErrors);
                    return errorResults;
                } catch (error) {
                    console.error('获取采购单错误信息错误:', error);
                    return {};
                }
            });
        }

        async function fetchPlaceOrderStatus(purchaseNumberList) {
            if (!purchaseNumberList || purchaseNumberList.length === 0) return {};
            
            const cacheKey = `placeOrderStatus_${purchaseNumberList.sort().join(',')}`;
            const cached = CacheManager.get(cacheKey);
            if (cached) return cached;
            
            return globalRequestQueue.add(async () => {
                try {
                    const statusResults = {};
                    
                    const promises = purchaseNumberList.map(async (purchaseNumber) => {
                        try {
                            const response = await fetch(`${apiBaseUrl}/get_place_status`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ conductor: String(userId), purchaseOrderId: purchaseNumber })
                            });

                            const result = await response.json();
                            console.log(`采购单${purchaseNumber}下单状态结果:`, result);
                            
                            if (result.success && result.data && result.data.length > 0) {
                                const statusInfo = result.data[0];
                                statusResults[purchaseNumber] = {
                                    hasTask: true,
                                    status: statusInfo.executor_name || '未知'
                                };
                            } else {
                                statusResults[purchaseNumber] = {
                                    hasTask: false,
                                    status: null
                                };
                            }
                        } catch (error) {
                            console.error(`获取采购单${purchaseNumber}下单状态失败:`, error);
                            statusResults[purchaseNumber] = {
                                hasTask: false,
                                status: null
                            };
                        }
                    });
                    
                    await Promise.all(promises);
                    
                    CacheManager.set(cacheKey, statusResults, CacheManager.config.placeOrderStatus);
                    return statusResults;
                } catch (error) {
                    console.error('获取下单状态错误:', error);
                    return {};
                }
            });
        }

        async function fetchPurchaseOrderStatus(taskId) {
            const cacheKey = `purchaseOrderStatus_${taskId}`;
            const cached = CacheManager.get(cacheKey);
            if (cached !== null) return cached;
            
            return globalRequestQueue.add(async () => {
                try {
                    const response = await fetch(`${apiBaseUrl}/purchase_order_status`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            id: taskId
                        })
                    });
                    
                    const result = await response.json();
                    console.log(`任务${taskId}采购单状态结果:`, result);
                    
                    if (result.success && result.data && result.data.length > 0) {
                        const status = result.data[0].status;
                        CacheManager.set(cacheKey, status, CacheManager.config.purchaseOrderStatus);
                        return status;
                    } else {
                        CacheManager.set(cacheKey, 0, CacheManager.config.purchaseOrderStatus);
                        return 0;
                    }
                } catch (error) {
                    console.error(`获取任务${taskId}采购单状态错误:`, error);
                    return 0;
                }
            });
        }

        async function updatePurchaseOrderStatus(taskId, newStatus) {
            try {
                const response = await fetch(`${apiBaseUrl}/purchase_orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: String(taskId), status: String(newStatus) })
                });

                const result = await response.json();
                console.log(`更新任务${taskId}采购单状态结果:`, result);
                
                if (result.success) {
                    CacheManager.clearByPrefix(`purchaseOrderStatus_${taskId}`);
                    showToast('采购单状态更新成功', 'success');
                    return true;
                } else {
                    showToast('采购单状态更新失败:' + (result.msg || '未知错误'), 'error');
                    return false;
                }
            } catch (error) {
                console.error('更新采购单状态错误:', error);
                showToast('更新采购单状态出错,请重试', 'error');
                return false;
            }
        }

        async function updateTaskStatusToRunning(taskId) {
            try {
                const response = await fetch(`${apiBaseUrl}/update_iw_status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: taskId.toString(),
                        iw_status: "二次运行-运行中"
                    })
                });
                
                const result = await response.json();
                console.log(`更新任务${taskId}状态为二次运行-运行中结果:`, result);
                
                if (result.success) {
                    showToast('任务状态已更新为运行中', 'success');
                    return true;
                } else {
                    showToast('更新任务状态失败:' + (result.msg || '未知错误'), 'error');
                    return false;
                }
            } catch (error) {
                console.error('更新任务状态错误:', error);
                showToast('更新任务状态出错,请重试', 'error');
                return false;
            }
        }

        async function submitFeedback(taskId, feedbackContent) {
            if (!feedbackContent.trim()) {
                showToast('请输入反馈内容', 'error');
                return false;
            }

            try {
                const response = await fetch(`${apiBaseUrl}/pur_feedbacks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        uid: userId,
                        intention_id: taskId,
                        info: `<p>${feedbackContent}</p>`
                    })
                });
                
                const result = await response.json();
                console.log(`提交反馈结果:`, result);
                
                if (result.success) {
                    showToast('反馈提交成功', 'success');
                    CacheManager.clearByPrefix(`feedbackData_${taskId}`);
                    
                    setTimeout(() => {
                        refreshTask(taskId);
                    }, 1000);
                    
                    return true;
                } else {
                    showToast('反馈提交失败:' + (result.msg || '未知错误'), 'error');
                    return false;
                }
            } catch (error) {
                console.error('提交反馈错误:', error);
                showToast('提交反馈出错,请重试', 'error');
                return false;
            }
        }

        async function submitPurchaseWait(orderIdList) {
            if (!orderIdList || orderIdList.length === 0) {
                showToast('没有选择订单', 'error');
                return;
            }

            try {
                const response = await fetch(`${apiBaseUrl}/post_transfer_order_task`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        orderIdList: orderIdList
                    })
                });
                
                const result = await response.json();
                console.log('提交等待采购结果:', result);
                
                if (result.success) {
                    showToast(`成功提交 ${orderIdList.length} 个订单到等待采购队列`, 'success');
                    CacheManager.clearByPrefix('orderTaskStatus_');
                } else {
                    showToast('提交失败:' + (result.msg || '未知错误'), 'error');
                }
            } catch (error) {
                console.error('提交等待采购错误:', error);
                showToast('提交出错,请重试', 'error');
            }
        }

        async function checkOrdersList(orderIdList, invoiceId) {
            if (!orderIdList || orderIdList.length === 0) {
                showToast('没有选择订单', 'error');
                return false;
            }

            try {
                const response = await fetch(`${apiBaseUrl}/check_tasks_list`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        orderid_list: orderIdList,
                        invoice_id: invoiceId
                    })
                });
                
                const result = await response.json();
                console.log('检查订单结果:', result);
                
                if (result.success) {
                    showToast(`成功提交 ${orderIdList.length} 个订单进行检查`, 'success');
                    return true;
                } else {
                    showToast('检查失败:' + (result.msg || '未知错误'), 'error');
                    return false;
                }
            } catch (error) {
                console.error('检查订单错误:', error);
                showToast('检查出错,请重试', 'error');
                return false;
            }
        }

        function calculateCompletedOrdersCount(orders) {
            if (!orders || orders.length === 0) return 0;
            
            let completedCount = 0;
            
            orders.forEach(order => {
                try {
                    const purchaseStatuses = parseJsonArray(order.purchase_status || '[]');
                    
                    if (purchaseStatuses.length > 0 && purchaseStatuses.every(status => status === '是')) {
                        completedCount++;
                    }
                } catch (error) {
                    console.error('计算订单完结状态错误:', error, order);
                }
            });
            
            return completedCount;
        }

        function renderFeedbackSection(feedbacks, invoiceId) {
            let html = `
            <div class="music_155_20577">
                <span class="music_155_20628">异常反馈</span>
                <div class="music_155_20634">
            `;
            
            if (!feedbacks || !feedbacks.length) {
                html += '<div class="no-data" style="width: 100%; padding: 20px;">暂无反馈信息</div>';
            } else {
                feedbacks.sort((a, b) => a.create_time - b.create_time);
                
                feedbacks.forEach((feedback, index) => {
                    const time = new Date(feedback.create_time);
                    const timeStr = time.toLocaleString();
                    const userName = feedback.user_name || 'Unknown';
                    const userInitial = userName.charAt(0);
                    
                    let feedbackInfo = feedback.info || '';
                    
                    if (index === 0) {
                        html += `
                        <div class="music_155_20670">
                            <div class="music_155_20671"></div>
                            <div class="music_155_20672">
                                <span class="music_155_20693">${userInitial}</span>
                                <div class="music_155_20673">
                                    <span class="music_155_20682">${userName}</span>
                                    <span class="music_155_20674">${feedbackInfo}</span>
                                    <span class="music_155_20688">${timeStr}</span>
                                </div>
                            </div>
                        </div>`;
                    } else {
                        html += `
                        <div class="music_155_20635">
                            <div class="music_155_20669"></div>
                            <div class="music_155_20636">
                                <span class="music_155_20663">${userInitial}</span>
                                <div class="music_155_20637">
                                    <span class="music_155_20657">${userName}</span>
                                    <span class="music_155_20638">${feedbackInfo}</span>
                                    <span class="music_155_20652">${timeStr}</span>
                                </div>
                            </div>
                        </div>`;
                    }
                });
            }
            
            html += `
                </div>
                <div class="feedback-edit-section">
                    <div class="feedback-edit-title">添加反馈</div>
                    <textarea 
                        class="feedback-textarea" 
                        id="feedback-input-${invoiceId}" 
                        placeholder="请输入反馈内容..."
                    ></textarea>
                    <button 
                        class="feedback-submit-btn" 
                        onclick="handleFeedbackSubmit('${invoiceId}')"
                    >
                        提交反馈
                    </button>
                </div>
            </div>`;
            
            return html;
        }

        function renderOrdersSection(orders, invoiceId) {
            let html = '<div class="section-title">订单信息</div>';
            html += '<div class="orders-container">';
            
            orders.forEach((order) => {
                const transferStatus = order.purchase_task || '否';
                
                html += `
                    <div class="order-item" data-order-id="${order.order_id}" data-invoice-id="${invoiceId}">
                        <div class="order-content">
                            ${renderOrderDetails(order, invoiceId, transferStatus)}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        function renderPurchaseSection(purchases, invoiceId) {
            let html = '<div class="purchase-section-header">';
            html += '<div class="section-title">采购单信息</div>';
            
            html += `
                <div class="payment-link-button" onclick="togglePaymentLinkDropdown('${invoiceId}')">
                    <div class="payment-link-button-inner">打开付款链接</div>
                    <div class="payment-link-dropdown" id="payment-link-dropdown-${invoiceId}">
                        <div class="payment-link-dropdown-item" onclick="getPaymentLinkAll('${invoiceId}')">获取全部订单链接</div>
                        <div class="payment-link-dropdown-item" onclick="getPaymentLinkSelected('${invoiceId}')">获取勾选的订单链接</div>
                    </div>
                </div>
            `;
            html += '</div>';
            
            html += '<div class="purchase-container">';
            
            const purchaseErrorsMap = taskPurchaseErrorsData[invoiceId] || {};
            const placeOrderStatusMap = taskPlaceOrderStatusData[invoiceId] || {};
            
            purchases.forEach((purchase, index) => {
                const purchaseNumber = purchase.dxm_po_number || '';
                const errorInfo = purchaseErrorsMap[purchaseNumber] || { hasError: false, errorMessage: null };
                const placeOrderInfo = placeOrderStatusMap[purchaseNumber] || { hasTask: false, status: null };
                
                console.log(`采购单${purchaseNumber}状态信息:`, {
                    errorInfo,
                    placeOrderInfo
                });
                
                html += '<div class="purchase-header">';
                html += `
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <input type="checkbox" class="purchase-checkbox" data-invoice-id="${invoiceId}" data-purchase-number="${purchaseNumber}" data-order-id-1688="${purchase.order_id_1688 || ''}" data-has-error="${errorInfo.hasError}">
                        <span>采购单编号: ${purchaseNumber}</span>
                        <span class="payment-status-badge" id="payment-status-${purchaseNumber}" style="margin-left: 8px; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; background: #f1f5f9; color: #64748b;">
                            查询中...
                        </span>
                    </div>
                `;
                
                let buttonHtml = '';
                
                if (placeOrderInfo.hasTask) {
                    if (placeOrderInfo.status === '已完成') {
                        if (errorInfo.hasError) {
                            buttonHtml = `<button class="order-btn" onclick="handleOrder('${purchaseNumber}')">下单</button>`;
                        } else {
                            buttonHtml = `<span class="order-status-text">已下单</span>`;
                        }
                    } else {
                        buttonHtml = `<span class="order-status-text">下单任务执行中...</span>`;
                    }
                } else {
                    if (errorInfo.hasError) {
                        buttonHtml = `<button class="order-btn" onclick="handleOrder('${purchaseNumber}')">下单</button>`;
                    }
                }
                
                html += buttonHtml;
                html += '</div>';
                html += '<div class="purchase-content">';
                
                if (errorInfo.hasError && errorInfo.errorMessage) {
                    html += `
                        <div class="purchase-error-info">
                            <div class="purchase-error-title">采购单错误信息:</div>
                            <div>${errorInfo.errorMessage}</div>
                        </div>
                    `;
                }
                
                html += `
                    <div class="purchase-info-row">
                        <div class="purchase-info-item">
                            <span class="label">1688订单号:</span>
                            <span class="value">${purchase.order_id_1688 || '无'}</span>
                        </div>
                        <div class="purchase-info-item">
                            <span class="label">供应商:</span>
                            <span class="value">${purchase.supplier || '无'}</span>
                        </div>
                        <div class="purchase-info-item">
                            <span class="label">货款:</span>
                            <span class="value">¥${purchase.total_amount || '0'}</span>
                        </div>
                        <div class="purchase-info-item">
                            <span class="label">含运费:</span>
                            <span class="value">¥${purchase.shipping_fee || '0'}</span>
                        </div>
                        <div class="purchase-info-item">
                            <span class="label">商品种类:</span>
                            <span class="value">${purchase.product_categories || '0'}</span>
                        </div>
                        <div class="purchase-info-item">
                            <span class="label">SKU数量:</span>
                            <span class="value">${purchase.sku_count || '0'}</span>
                        </div>
                        <div class="purchase-info-item">
                            <span class="label">1688订单状态:</span>
                            <span class="value">${purchase.order_status || '待下单'}</span>
                        </div>
                        <div class="purchase-info-item">
                            <span class="label">砍价备注:</span>
                            <span class="value">${purchase.bargain_note || '无'}</span>
                        </div>
                        <div class="purchase-info-item">
                            <span class="label">1688聊天窗口:</span>
                            <span class="value">
                                ${purchase.chat_link ? 
                                    `<a href="${purchase.chat_link}" target="_blank" rel="noopener noreferrer" class="view-1688-btn">打开聊天窗口</a>` : 
                                    '暂无聊天窗口'
                                }
                            </span>
                        </div>
                    </div>
                `;
                
                if (purchase.ali1688_buyer_message && purchase.ali1688_buyer_message.trim() !== '') {
                    html += `
                        <div class="buyer-message-info">
                            <div class="buyer-message-title">1688买家留言:</div>
                            <div class="buyer-message-content">${purchase.ali1688_buyer_message}</div>
                        </div>
                    `;
                }
                
                if (purchase.purchase_remark && purchase.purchase_remark.trim() !== '') {
                    html += `
                        <div class="purchase-remark-info">
                            <div class="purchase-remark-title">采购备注:</div>
                            <div class="purchase-remark-content">${purchase.purchase_remark}</div>
                        </div>
                    `;
                }
                
                if (purchase.name) {
                    html += '<div class="purchase-products">';
                    try {
                        const names = parseJsonArray(purchase.name);
                        const skus = parseJsonArray(purchase.sku || '[]');
                        const quantities = parseJsonArray(purchase.quantity || '[]');
                        const prices = parseJsonArray(purchase.price || '[]');
                        const imgurls = parseJsonArray(purchase.imgurl || '[]');
                        
                        let ali1688Links = [];
                        if (purchase.ali_1688) {
                            try {
                                ali1688Links = parseJsonArray(purchase.ali_1688);
                            } catch (e) {
                                console.error('解析1688链接错误:', e);
                            }
                        }
                        
                        names.forEach((name, i) => {
                            const ali1688Link = ali1688Links[i] || '';
                            
                            html += `
                                <div class="purchase-product-item">
                                    <img src="${imgurls[i] || purchase.image_url || 'https://via.placeholder.com/150'}" 
                                         alt="${name}" class="purchase-product-image">
                                    <div class="purchase-product-info">
                                        <div class="purchase-product-name">${name}</div>
                                        <div class="purchase-product-sku">${skus[i] || '无SKU'}</div>
                                        <div class="purchase-product-details">
                                            <span class="purchase-product-quantity">x ${quantities[i] || '0'}</span>
                                            <span class="purchase-product-price">¥ ${prices[i] || '0'}</span>
                                        </div>
                                        ${ali1688Link ? 
                                            `<a href="${ali1688Link}" target="_blank" rel="noopener noreferrer" class="view-1688-btn">查看1688链接</a>` : 
                                            '<span class="no-1688-link">暂无1688链接</span>'
                                        }
                                    </div>
                                </div>
                            `;
                        });
                    } catch (e) {
                        console.error('解析采购单商品信息错误:', e);
                    }
                    html += '</div>';
                }
                
                html += '</div>';
                
                if (index < purchases.length - 1) {
                    html += '<hr style="margin: 20px 0; border: 1px solid var(--line);">';
                }
            });
            
            html += '</div>';
            
            purchases.forEach((purchase) => {
                const purchaseNumber = purchase.dxm_po_number || '';
                const orderId1688 = purchase.order_id_1688 || '';
                if (orderId1688) {
                    fetchPaymentStatus(orderId1688, purchaseNumber);
                } else {
                    updatePaymentStatusUI(purchaseNumber, '无1688订单号', 'error');
                }
            });
            
            return html;
        }

        function renderOrderDetails(order, invoiceId, transferStatus) {
            let html = '<div class="order-header-info">';
            
            html += `
                <div class="order-header-title">
                    <input type="checkbox" class="order-checkbox" data-order-id="${order.order_id}" data-invoice-id="${invoiceId}">
                    <span>订单详情</span>
                </div>
            `;
            
            html += `
                <div class="order-header-row">
                    <div class="order-header-item">
                        <span class="label">订单号:</span>
                        <span class="value">${order.order_id || '未知'}</span>
                    </div>
                    <div class="order-header-item">
                        <span class="label">国家:</span>
                        <span class="value">${order.nation || '--'}</span>
                    </div>
                    <div class="order-header-item">
                        <span class="label">物流渠道:</span>
                        <span class="value">${order.channel || '--'}</span>
                    </div>
                    <div class="order-header-item">
                        <span class="label">物流渠道备注:</span>
                        <span class="value">${order.channel_remark || ''}</span>
                    </div>
                    <div class="order-header-item">
                        <span class="label">运单号:</span>
                        <span class="value">${order.waybill_num || '无'}</span>
                    </div>
                    <div class="order-header-item">
                        <span class="label">包装号:</span>
                        <span class="value">${order.package_id || '无'}</span>
                    </div>
                    <div class="order-header-item">
                        <span class="label">移仓状态:</span>
                        <span class="value">${transferStatus}</span>
                    </div>
                </div>
            `;
            
            html += '</div>';
            
            html += '<div class="products-container">';
            
            try {
                const productImgs = parseJsonArray(order.product_img);
                const variants = parseJsonArray(order.stop_product_variant);
                const quantities = parseJsonArray(order.num);
                const titles = parseJsonArray(order.customer_english_title);
                const links = parseJsonArray(order.ali_link);
                const skus = parseJsonArray(order.product_sku_info);
                const statuses = parseJsonArray(order.status);
                const purchaseStatuses = parseJsonArray(order.purchase_status);
                
                const productCount = Math.max(
                    productImgs.length,
                    variants.length,
                    quantities.length,
                    titles.length,
                    purchaseStatuses.length,
                    1
                );
                
                let displayableProducts = [];
                for (let i = 0; i < productCount; i++) {
                    const purchaseStatus = purchaseStatuses[i] || '否';
                    if (order.purchase_task && purchaseStatus === '是') {
                        continue;
                    }
                    displayableProducts.push({
                        index: i,
                        imgUrl: productImgs[i] || 'https://via.placeholder.com/150',
                        variant: variants[i] || '未知',
                        quantity: quantities[i] || 1,
                        title: titles[i] || '未知产品',
                        link: links[i] || '',
                        sku: skus[i] || '无',
                        checkStatus: statuses[i] || '',
                        purchaseStatus: purchaseStatus
                    });
                }

                
                if (displayableProducts.length === 0 && order.purchase_task) {
                    html += '<div class="order-all-purchased">该订单所有产品均已生成采购单</div>';
                } else if (displayableProducts.length > 0) {
                    displayableProducts.forEach(product => {
                        let linkHtml = '无';
                        if (product.link) {
                            linkHtml = `<a href="${product.link}" target="_blank" rel="noopener noreferrer">${truncateUrl(product.link)}</a>`;
                        }
                        
                        html += `
                            <div class="product-row">
                                <div class="product-image-container">
                                    <img src="${product.imgUrl}" alt="${product.title}" class="product-image">
                                </div>
                                <div class="product-info-container">
                                    <div class="product-title">
                                        ${product.title}
                                        <div class="product-variant-info">
                                            <span class="variant-label">客户产品变体:</span>
                                            <span class="variant-value">${product.variant}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="product-quantity">
                                    <div class="quantity-label">数量</div>
                                    <div class="quantity-value">${product.quantity}</div>
                                </div>
                                <div class="product-link">
                                    <div class="link-label">1688链接</div>
                                    <div class="link-value">${linkHtml}</div>
                                </div>
                                <div class="product-sku">
                                    <div class="sku-label">店小秘SKU</div>
                                    <div class="sku-value">${product.sku}</div>
                                </div>
                                <div class="product-transfer-status">
                                    <div class="transfer-status-label">移仓状态</div>
                                    <div class="transfer-status-value">${product.purchaseStatus}</div>
                                </div>
                                <div class="product-actions">
                                    <button class="detail-btn" onclick="showProductDetail('${order.order_id || ''}', ${product.index})">详情</button>
                                </div>
                                <div class="product-check-status">
                                    <div class="check-status-label">检查配对状态:</div>
                                    <div class="check-status-value">${product.checkStatus}</div>
                                </div>
                            </div>
                        `;
                    });
                }
                
            } catch (e) {
                console.error('解析产品信息错误:', e);
                html += '<div>产品信息解析错误</div>';
            }
            
            html += '</div>';
            
            return html;
        }

        function truncateUrl(url) {
            if (!url) return '';
            if (url.length <= 20) return url;
            return url.substring(0, 17) + '···';
        }

        function showProductDetail(orderId, productIndex) {
            console.log('显示产品详情:', orderId, '产品索引:', productIndex);
            
            try {
                fetchOrderDetailFromCache(orderId, productIndex);
            } catch (e) {
                console.error('处理产品详情数据错误:', e);
                showToast('获取产品详情失败,请重试', 'error');
            }
        }

        function fetchOrderDetailFromCache(orderId, productIndex) {
            try {
                let orderData = null;
                for (const invoiceId in taskOrdersData) {
                    const orders = taskOrdersData[invoiceId];
                    orderData = orders.find(order => order.order_id === orderId);
                    if (orderData) break;
                }
                
                if (!orderData) {
                    showToast('订单数据未找到', 'error');
                    return;
                }
                
                fillProductDetailPopup(orderData, productIndex);
                
                productDetailPopup.classList.add('active');
                popupOverlay.classList.add('active');
                
                document.body.style.overflow = 'hidden';
                
            } catch (error) {
                console.error('获取订单详情错误:', error);
                showToast('获取订单详情失败,请重试', 'error');
            }
        }

        function fillProductDetailPopup(order, productIndex) {
            try {
                document.getElementById('popup-shop-num').textContent = order.shop_num || '';
                document.getElementById('popup-waybill-num').textContent = order.waybill_num || '';
                document.getElementById('popup-huo-remark').textContent = order.huo_remark || '';
                
                document.getElementById('popup-product-sku-info').textContent = formatJsonArrayField(order.product_sku_info, productIndex);
                document.getElementById('popup-ali-sku').textContent = formatJsonArrayField(order.ali_sku, productIndex);
                
                let orderInfo = {};
                if (order.info && order.info !== "") {
                    try {
                        orderInfo = typeof order.info === 'string' ? JSON.parse(order.info) : order.info;
                    } catch (e) {
                        console.error('解析收件人信息出错:', e);
                    }
                }
                
                document.getElementById('popup-name').textContent = orderInfo.Name || '';
                document.getElementById('popup-email').textContent = orderInfo.Email || '';
                document.getElementById('popup-addr').textContent = orderInfo.Addr || '';
                document.getElementById('popup-city').textContent = orderInfo.City || '';
                document.getElementById('popup-postcode').textContent = orderInfo.Postcode || '';
                document.getElementById('popup-province').textContent = orderInfo.Province || '';
                document.getElementById('popup-phone').textContent = orderInfo.Phone || '';
                document.getElementById('popup-pay-status').textContent = orderInfo.PayStatus === '1' ? '已付款' : '未付款';
                
                document.getElementById('popup-package-id').textContent = order.package_id || '';
                document.getElementById('popup-shipments-remark').textContent = formatJsonArrayField(order.shipments_remark, productIndex);
                document.getElementById('popup-ali-buyer-word').textContent = formatJsonArrayField(order.ali_buyer_word, productIndex);
                document.getElementById('popup-purchase-remark').textContent = formatJsonArrayField(order.purchase_remark, productIndex);
                
                document.getElementById('popup-remark').textContent = formatJsonArrayField(order.remark, productIndex);
                
                document.getElementById('popup-special-pairing').textContent = formatSpecialPairing(order.special_pairing);
                
            } catch (error) {
                console.error('填充弹窗数据错误:', error);
                showToast('处理详情数据失败', 'error');
            }
        }

        function closeProductDetailPopup() {
            productDetailPopup.classList.remove('active');
            popupOverlay.classList.remove('active');
            
            document.body.style.overflow = '';
        }

        async function refreshTask(invoiceId, keepScrollPosition = false) {
            console.log('刷新任务:', invoiceId);
            
            try {
                let scrollPosition = 0;
                if (keepScrollPosition) {
                    scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
                    console.log('保存滚动位置:', scrollPosition);
                }
                
                taskList.innerHTML = '<div class="loading">刷新中...</div>';
                
                CacheManager.clearByPrefix(`purchaseTaskInfo_${invoiceId}`);
                CacheManager.clearByPrefix(`purchaseInfo_${invoiceId}`);
                CacheManager.clearByPrefix(`feedbackData_${invoiceId}`);
                CacheManager.clearByPrefix(`orderTaskStatus_`);
                CacheManager.clearByPrefix(`purchaseOrderErrors_`);
                CacheManager.clearByPrefix(`placeOrderStatus_`);
                CacheManager.clearByPrefix(`purchaseOrderStatus_`);
                
                await loadTaskDetail(invoiceId);
                
                if (keepScrollPosition) {
                    setTimeout(() => {
                        window.scrollTo(0, scrollPosition);
                        console.log('恢复滚动位置:', scrollPosition);
                    }, 100);
                }
                
                showToast('任务刷新成功', 'success');
            } catch (error) {
                console.error('刷新任务错误:', error);
                showToast('刷新任务出错,请重试', 'error');
            }
        }

        function toggleCollapsedOrders(invoiceId) {
            const isCollapsed = taskCollapsedState[invoiceId] || false;
            taskCollapsedState[invoiceId] = !isCollapsed;
            
            const toggleButton = document.getElementById(`toggle-text-${invoiceId}`);
            const orderItems = document.querySelectorAll(`[data-invoice-id="${invoiceId}"] .order-item`);
            
            orderItems.forEach(orderItem => {
                const hasAllPurchased = orderItem.querySelector('.order-all-purchased');
                if (hasAllPurchased) {
                    if (taskCollapsedState[invoiceId]) {
                        orderItem.classList.add('collapsed');
                    } else {
                        orderItem.classList.remove('collapsed');
                    }
                }
            });
            
            if (toggleButton) {
                toggleButton.textContent = taskCollapsedState[invoiceId] ? '展开订单' : '折叠订单';
            }
        }

        function togglePurchaseDropdown(invoiceId) {
            event.stopPropagation();
            const dropdown = document.getElementById(`purchase-dropdown-${invoiceId}`);
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        function toggleCheckDropdown(invoiceId) {
            event.stopPropagation();
            const dropdown = document.getElementById(`check-dropdown-${invoiceId}`);
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        function togglePurchaseStatusDropdown(invoiceId) {
            event.stopPropagation();
            const dropdown = document.getElementById(`purchase-status-options-${invoiceId}`);
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        function togglePaymentLinkDropdown(invoiceId) {
            event.stopPropagation();
            const dropdown = document.getElementById(`payment-link-dropdown-${invoiceId}`);
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        async function changePurchaseStatus(invoiceId, newStatus) {
            event.stopPropagation();
            
            const success = await updatePurchaseOrderStatus(invoiceId, newStatus);
            if (success) {
                const statusButton = document.getElementById(`purchase-status-btn-${invoiceId}`);
                if (statusButton) {
                    statusButton.textContent = PURCHASE_STATUS_MAP[newStatus];
                }
                
                taskPurchaseOrderStatusData[invoiceId] = newStatus;
            }
            
            const dropdown = document.getElementById(`purchase-status-options-${invoiceId}`);
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        }

        async function handleFeedbackSubmit(invoiceId) {
            const textarea = document.getElementById(`feedback-input-${invoiceId}`);
            if (!textarea) {
                showToast('找不到输入框', 'error');
                return;
            }
            
            const content = textarea.value.trim();
            if (!content) {
                showToast('请输入反馈内容', 'error');
                return;
            }
            
            const submitBtn = textarea.nextElementSibling;
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = '提交中...';
            }
            
            const success = await submitFeedback(invoiceId, content);
            
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = '提交反馈';
            }
            
            if (success) {
                textarea.value = '';
            }
        }

        function submitSelectedOrders(invoiceId) {
            event.stopPropagation();
            const checkboxes = document.querySelectorAll(`[data-invoice-id="${invoiceId}"] .order-checkbox:checked`);
            const orderIds = Array.from(checkboxes).map(cb => cb.dataset.orderId);
            
            if (orderIds.length === 0) {
                showToast('请先勾选订单', 'error');
                return;
            }
            
            submitPurchaseWait(orderIds);
            
            updateIwStatus(invoiceId, '等待采购');
            
            const dropdown = document.getElementById(`purchase-dropdown-${invoiceId}`);
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        }

        function submitAllOrders(invoiceId) {
            event.stopPropagation();
            const orders = taskOrdersData[invoiceId] || [];
            const orderIds = orders.map(order => order.order_id).filter(id => id);
            
            if (orderIds.length === 0) {
                showToast('没有可提交的订单', 'error');
                return;
            }
            
            submitPurchaseWait(orderIds);
            
            updateIwStatus(invoiceId, '等待采购');
            
            const dropdown = document.getElementById(`purchase-dropdown-${invoiceId}`);
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        }


        async function updateIwStatus(taskId, status) {
            try {
                const response = await fetch(`${apiBaseUrl}/update_iw_status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: taskId.toString(),
                        iw_status: status
                    })
                });
                
                const result = await response.json();
                console.log(`更新任务${taskId}状态为${status}结果:`, result);
                
                if (result.success) {
                    showToast(`任务状态已更新为${status}`, 'success');
                    
                    setTimeout(() => {
                        refreshTaskList();
                    }, 2000);
                    
                    return true;
                } else {
                    showToast('更新任务状态失败:' + (result.msg || '未知错误'), 'error');
                    return false;
                }
            } catch (error) {
                console.error('更新任务状态错误:', error);
                showToast('更新任务状态出错,请重试', 'error');
                return false;
            }
        }

        async function submitSelectedOrdersCheck(invoiceId) {
            event.stopPropagation();
            const checkboxes = document.querySelectorAll(`[data-invoice-id="${invoiceId}"] .order-checkbox:checked`);
            const orderIds = Array.from(checkboxes).map(cb => cb.dataset.orderId);
            
            if (orderIds.length === 0) {
                showToast('请先勾选订单', 'error');
                return;
            }
            
            try {
                await checkOrdersList(orderIds, invoiceId);
                
                await updateTaskStatusToRunning(invoiceId);
                
                setTimeout(() => {
                    fetchTasks();
                }, 2000);
                
            } catch (error) {
                console.error('检查订单操作失败:', error);
                showToast('检查订单操作失败,请重试', 'error');
            }
            
            const dropdown = document.getElementById(`check-dropdown-${invoiceId}`);
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        }

        async function submitAllOrdersCheck(invoiceId) {
            event.stopPropagation();
            const orders = taskOrdersData[invoiceId] || [];
            const orderIds = orders.map(order => order.order_id).filter(id => id);
            
            if (orderIds.length === 0) {
                showToast('没有可检查的订单', 'error');
                return;
            }
            
            try {
                await checkOrdersList(orderIds, invoiceId);
                
                await updateTaskStatusToRunning(invoiceId);
                
                setTimeout(() => {
                    fetchTasks();
                }, 2000);
                
            } catch (error) {
                console.error('检查订单操作失败:', error);
                showToast('检查订单操作失败,请重试', 'error');
            }
            
            const dropdown = document.getElementById(`check-dropdown-${invoiceId}`);
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        }

        async function getPaymentLinkAll(invoiceId) {
            event.stopPropagation();
            
            const purchases = taskPurchaseData[invoiceId] || [];
            const purchaseErrorsMap = taskPurchaseErrorsData[invoiceId] || {};
            
            const orderIds1688 = [];
            purchases.forEach(purchase => {
                const purchaseNumber = purchase.dxm_po_number;
                const order1688Id = purchase.order_id_1688;
                const errorInfo = purchaseErrorsMap[purchaseNumber] || { hasError: false };
                
                // 移除错误检查：允许所有有order_id_1688的采购单获取付款链接
                if (order1688Id) {
                    orderIds1688.push(order1688Id);
                }
            });
            
            if (orderIds1688.length === 0) {
                showToast('没有可获取付款链接的采购单', 'error');
                return;
            }
            
            await fetchPaymentLink(orderIds1688);
            
            const dropdown = document.getElementById(`payment-link-dropdown-${invoiceId}`);
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        }

        async function getPaymentLinkSelected(invoiceId) {
            event.stopPropagation();
            
            const checkboxes = document.querySelectorAll(`[data-invoice-id="${invoiceId}"] .purchase-checkbox:checked`);
            
            if (checkboxes.length === 0) {
                showToast('请先勾选采购单', 'error');
                return;
            }
            
            const orderIds1688 = [];
            checkboxes.forEach(checkbox => {
                const order1688Id = checkbox.getAttribute('data-order-id-1688');
                const hasError = checkbox.dataset.hasError === 'true';
                
                if (order1688Id) {
                    orderIds1688.push(order1688Id);
                }
            });
            
            if (orderIds1688.length === 0) {
                showToast('勾选的采购单中没有1688订单号', 'error');
                return;
            }
            
            await fetchPaymentLink(orderIds1688);
            
            const dropdown = document.getElementById(`payment-link-dropdown-${invoiceId}`);
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        }

                async function fetchPaymentLink(orderIds1688) {
            showLoadingOverlay();
            
            try {
                const response = await fetch(paymentApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        order_ids: orderIds1688
                    }),
                    timeout: 30000
                });
                
                const result = await response.json();
                console.log('获取付款链接结果:', result);
                
                // 适配新API格式：传递完整result对象
                showPaymentLinkModal(result);
            } catch (error) {
                console.error('获取付款链接错误:', error);
                showPaymentLinkModal({
                    success: false,
                    errorMsg: '网络错误: ' + error.message
                });
            } finally {
                hideLoadingOverlay();
            }
        }

                function showPaymentLinkModal(result) {
            const modal = document.getElementById('payment-link-modal');
            const title = document.getElementById('payment-link-modal-title');
            const contentDiv = document.getElementById('payment-link-modal-content');
            
            // 适配新API格式
            const success = result.success === true || result.success === "true";
            const totalCount = result.totalCount || 0;
            const successCount = result.successCount || 0;
            const failedCount = result.failedCount || 0;
            const payUrl = result.payUrl || '';
            const errorMsg = result.errorMsg || '';
            const successOrderIds = result.successOrderIds || [];
            const failedOrderIds = result.failedOrderIds || [];
            
            let htmlContent = '';
            
            // 情况1：全部成功
            if (successCount === totalCount && successCount > 0) {
                title.textContent = '✅ 付款链接获取成功';
                title.style.color = '#10b981';
                htmlContent = `
                    <div class="payment-link-success">
                        <div class="payment-info-box" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                            <div style="font-size: 14px; color: #065f46; margin-bottom: 8px;">
                                <strong>成功获取 ${successCount} 个订单的付款链接</strong>
                            </div>
                            <div style="font-size: 12px; color: #047857;">
                                订单ID: ${successOrderIds.join(', ')}
                            </div>
                        </div>
                        <div class="payment-link-text" style="font-size: 14px; color: #475569; margin-bottom: 12px;">
                            请点击下方链接打开付款页面:
                        </div>
                        <a href="${payUrl}" target="_blank" class="payment-link-url" 
                           style="display: block; padding: 12px; background: linear-gradient(135deg, #3b82f6, #2563eb); 
                                  color: white; text-decoration: none; border-radius: 10px; text-align: center; 
                                  font-weight: 600; transition: all 0.3s; word-break: break-all;"
                           onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(37,99,235,0.3)';"
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            🔗 打开付款页面
                        </a>
                        <div style="font-size: 11px; color: #94a3b8; margin-top: 8px; text-align: center;">
                            ${payUrl}
                        </div>
                    </div>
                `;
            }
            // 情况2：部分成功
            else if (successCount > 0 && failedCount > 0) {
                title.textContent = '⚠️ 部分订单获取成功';
                title.style.color = '#f59e0b';
                htmlContent = `
                    <div class="payment-link-partial">
                        <!-- 成功部分 -->
                        <div class="payment-success-section" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                            <div style="font-size: 14px; color: #065f46; margin-bottom: 8px;">
                                <strong>✅ 成功: ${successCount} 个订单</strong>
                            </div>
                            <div style="font-size: 12px; color: #047857; margin-bottom: 12px;">
                                订单ID: ${successOrderIds.join(', ')}
                            </div>
                            <div class="payment-link-text" style="font-size: 13px; color: #065f46; margin-bottom: 10px;">
                                付款链接:
                            </div>
                            <a href="${payUrl}" target="_blank" 
                               style="display: block; padding: 10px; background: linear-gradient(135deg, #10b981, #059669); 
                                      color: white; text-decoration: none; border-radius: 8px; text-align: center; 
                                      font-weight: 600; font-size: 13px; transition: all 0.3s;"
                               onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(16,185,129,0.3)';"
                               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                🔗 打开付款页面
                            </a>
                        </div>
                        
                        <!-- 失败部分 -->
                        <div class="payment-failed-section" style="background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 16px; border-radius: 12px;">
                            <div style="font-size: 14px; color: #92400e; margin-bottom: 8px;">
                                <strong>❌ 失败: ${failedCount} 个订单</strong>
                            </div>
                            <div style="font-size: 12px; color: #b45309; margin-bottom: 8px;">
                                订单ID: ${failedOrderIds.join(', ')}
                            </div>
                            ${errorMsg ? `
                                <div style="font-size: 12px; color: #92400e; background: rgba(255,255,255,0.6); 
                                           padding: 8px; border-radius: 6px; border-left: 3px solid #f59e0b;">
                                    <strong>失败原因:</strong> ${errorMsg}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            // 情况3：全部失败
            else {
                title.textContent = '❌ 获取付款链接失败';
                title.style.color = '#ef4444';
                htmlContent = `
                    <div class="payment-link-error" style="background: linear-gradient(135deg, #fecaca, #fca5a5); padding: 16px; border-radius: 12px;">
                        <div style="font-size: 14px; color: #991b1b; margin-bottom: 12px;">
                            <strong>失败订单数: ${failedCount}</strong>
                        </div>
                        ${failedOrderIds.length > 0 ? `
                            <div style="font-size: 12px; color: #b91c1c; margin-bottom: 12px;">
                                订单ID: ${failedOrderIds.join(', ')}
                            </div>
                        ` : ''}
                        <div style="font-size: 13px; color: #7f1d1d; background: rgba(255,255,255,0.6); 
                                   padding: 12px; border-radius: 8px; border-left: 4px solid #ef4444;">
                            <strong>错误信息:</strong><br>
                            ${errorMsg || '未知错误，请稍后重试'}
                        </div>
                    </div>
                `;
            }
            
            contentDiv.innerHTML = htmlContent;
            modal.classList.add('active');
            popupOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closePaymentLinkModal() {
            const modal = document.getElementById('payment-link-modal');
            modal.classList.remove('active');
            popupOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        async function fetchPaymentStatus(orderId1688, purchaseNumber) {
            if (!orderId1688) {
                updatePaymentStatusUI(purchaseNumber, '无订单号', 'error');
                return;
            }
            
            try {
                const response = await fetch(`http://59.110.116.113:8000/api/order-status/${orderId1688}`, {
                    method: 'GET',
                    timeout: 10000
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log(`订单${orderId1688}支付状态查询结果:`, result);
                
                if (result.success === "true" && result.result && result.result.productItems && result.result.productItems.length > 0) {
                    const statusStr = result.result.productItems[0].statusStr;
                    if (statusStr) {
                        updatePaymentStatusUI(purchaseNumber, statusStr, 'success');
                    } else {
                        updatePaymentStatusUI(purchaseNumber, '状态未知', 'error');
                    }
                } else {
                    updatePaymentStatusUI(purchaseNumber, '查询失败', 'error');
                }
            } catch (error) {
                console.error(`查询订单${orderId1688}支付状态失败:`, error);
                updatePaymentStatusUI(purchaseNumber, '查询失败', 'error');
            }
        }

        function updatePaymentStatusUI(purchaseNumber, statusText, statusType) {
            const statusElement = document.getElementById(`payment-status-${purchaseNumber}`);
            if (!statusElement) return;
            
            statusElement.textContent = statusText;
            
            if (statusType === 'success') {
                if (statusText.includes('已付款') || statusText.includes('已支付')) {
                    statusElement.style.background = 'linear-gradient(135deg, #d1fae5, #a7f3d0)';
                    statusElement.style.color = '#065f46';
                } else if (statusText.includes('未付款') || statusText.includes('待付款')) {
                    statusElement.style.background = 'linear-gradient(135deg, #fef3c7, #fde68a)';
                    statusElement.style.color = '#92400e';
                } else {
                    statusElement.style.background = 'linear-gradient(135deg, #e0e7ff, #c7d2fe)';
                    statusElement.style.color = '#3730a3';
                }
            } else if (statusType === 'error') {
                statusElement.style.background = 'linear-gradient(135deg, #fecaca, #fca5a5)';
                statusElement.style.color = '#991b1b';
            }
        }

        async function handleOrder(purchaseNumber) {
            console.log('处理下单:', purchaseNumber);

            try {
                const response = await fetch(`${apiBaseUrl}/post_place_order_task`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ conductor: String(userId), purchaseOrderId: purchaseNumber })
                });

                const result = await response.json();
                console.log('下单任务提交结果:', result);
                
                if (result.success) {
                    showToast(`采购单 ${purchaseNumber} 下单任务已提交`, 'success');
                    CacheManager.clearByPrefix('placeOrderStatus_');
                    CacheManager.clearByPrefix('purchaseOrderErrors_');
                    
                    for (const invoiceId in taskPurchaseData) {
                        const purchases = taskPurchaseData[invoiceId];
                        if (purchases.some(p => p.dxm_po_number === purchaseNumber)) {
                            setTimeout(() => {
                                refreshTask(invoiceId, true);
                            }, 2000);
                            break;
                        }
                    }
                } else {
                    showToast('下单任务提交失败:' + (result.msg || '未知错误'), 'error');
                }
            } catch (error) {
                console.error('提交下单任务错误:', error);
                showToast('提交下单任务出错,请重试', 'error');
            }
        }

        function formatJsonArrayField(field, index) {
            if (!field) return '';
            
            try {
                if (Array.isArray(field)) {
                    return field[index] || '';
                }
                
                if (typeof field === 'string') {
                    const parsedArray = parseJsonArray(field);
                    if (Array.isArray(parsedArray)) {
                        return parsedArray[index] || '';
                    }
                }
                return field.toString();
            } catch (e) {
                console.error('解析字段错误:', e, field);
                if (typeof field === 'string') {
                    return field;
                }
                return '';
            }
        }

        function formatSpecialPairing(specialPairing) {
            if (!specialPairing) return '';
            
            try {
                if (Array.isArray(specialPairing)) {
                    return specialPairing.map(processSpecialPairingItem).join('\n');
                }
                
                if (typeof specialPairing === 'string') {
                    const parsedData = parseJsonArray(specialPairing);
                    if (Array.isArray(parsedData)) {
                        return parsedData.map(processSpecialPairingItem).join('\n');
                    }
                }
                
                return specialPairing.toString();
            } catch (e) {
                console.error('解析特殊配对信息错误:', e, specialPairing);
                if (typeof specialPairing === 'string') {
                    return specialPairing;
                }
                return '';
            }
        }

        function processSpecialPairingItem(item) {
            try {
                if (typeof item === 'string') {
                    try {
                        const pairingData = parseJsonArray(item);
                        if (Array.isArray(pairingData)) {
                            return pairingData.map(pair => 
                                `${pair.customerVariant || ''} -> ${pair.alibabaSku || ''}`
                            ).join(', ');
                        }
                    } catch (e) {
                    }
                    return item;
                } else if (Array.isArray(item)) {
                    return item.map(subItem => {
                        if (typeof subItem === 'object') {
                            return `${subItem.customerVariant || ''} -> ${subItem.alibabaSku || ''}`;
                        }
                        return subItem;
                    }).join(', ');
                }
                return String(item);
            } catch (e) {
                console.error('处理特殊配对项目错误:', e, item);
                return String(item);
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function formatDate(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        window.showHelpPopup = showHelpPopup;
        window.hideHelpPopup = hideHelpPopup;
        window.selectCategory = selectCategory;
        window.filterByInvoiceCode = filterByInvoiceCode;
        window.togglePurchaseDropdown = togglePurchaseDropdown;
        window.toggleCheckDropdown = toggleCheckDropdown;
        window.togglePurchaseStatusDropdown = togglePurchaseStatusDropdown;
        window.togglePaymentLinkDropdown = togglePaymentLinkDropdown;
        window.changePurchaseStatus = changePurchaseStatus;
        window.handleFeedbackSubmit = handleFeedbackSubmit;
        window.submitSelectedOrders = submitSelectedOrders;
        window.submitAllOrders = submitAllOrders;
        window.submitSelectedOrdersCheck = submitSelectedOrdersCheck;
        window.submitAllOrdersCheck = submitAllOrdersCheck;
        window.getPaymentLinkAll = getPaymentLinkAll;
        window.getPaymentLinkSelected = getPaymentLinkSelected;
        window.closePaymentLinkModal = closePaymentLinkModal;
        window.toggleCollapsedOrders = toggleCollapsedOrders;
        window.refreshTask = refreshTask;
        window.showProductDetail = showProductDetail;
        window.handleOrder = handleOrder;
        window.handleCompleteTask = handleCompleteTask;
        window.openScheduleModal = openScheduleModal;
        window.closeScheduleModal = closeScheduleModal;
        window.quickSelectDate = quickSelectDate;
        window.toggleAllStaff = toggleAllStaff;
        window.updateScheduleCount = updateScheduleCount;
        window.loadScheduleData = loadScheduleData;
        window.resetSchedule = resetSchedule;
        window.saveScheduleData = saveScheduleData;
    </script>
</body>
</html>